/** */
package org.openmrs.module.eptsreports.reporting.library.queries;

/** @author StÃ©lio Moiane */
public interface TxRttQueries {

  class QUERY {

    public static final String findMinEncounterDateByPatientInReportingPeriod =
        "select patient_id, min(min_date) from ( "
            + "SELECT e.patient_id, MIN(e.encounter_datetime)  min_date "
            + "FROM patient p inner join encounter e on p.patient_id=e.patient_id "
            + "WHERE p.voided=0 and e.encounter_type in (6,9,18) AND e.voided=0 and e.encounter_datetime>=:startDate and e.encounter_datetime<=:endDate and e.patient_id in(:patientIds) and e.location_id=:location GROUP BY p.patient_id "
            + "union Select p.patient_id,min(value_datetime) min_date from patient p "
            + " inner join encounter e on p.patient_id=e.patient_id "
            + " inner join obs o on e.encounter_id=o.encounter_id "
            + " where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and o.concept_id=23866 and o.value_datetime is not null "
            + " and o.value_datetime>=:startDate and o.value_datetime<=:endDate and e.patient_id in(:patientIds) and e.location_id=:location group by p.patient_id) min_data_consulta_levantamento group by patient_id ";

    public static final String findMaxEncounterDateByPatientInReportingPeriod =
        "select patient_id, max(last_date) from ( "
            + "SELECT e.patient_id, max(e.encounter_datetime)  last_date "
            + "FROM patient p inner join encounter e on p.patient_id=e.patient_id "
            + "WHERE p.voided=0 and e.encounter_type in (6,9,18) AND e.voided=0 and e.encounter_datetime<:startDate and e.location_id=:location and e.patient_id in(:patientIds) GROUP BY p.patient_id "
            + "union Select p.patient_id,max(value_datetime) last_date from patient p "
            + " inner join encounter e on p.patient_id=e.patient_id "
            + " inner join obs o on e.encounter_id=o.encounter_id "
            + " where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and o.concept_id=23866 and o.value_datetime is not null "
            + " and o.value_datetime<:startDate and e.location_id=:location and e.patient_id in(:patientIds) group by p.patient_id ) last_consulta_levantamento group by patient_id ";

    public static final String findNextScheduledFilaEncountersByPatientsIdAndLocation =
        "						"
            + " select encounter.patient_id, encounter.encounter_datetime, obs.value_datetime  					"
            + " from encounter 																					"
            + "    join obs on obs.encounter_id = encounter.encounter_id 										"
            + "  where encounter.voided = 0 and obs.voided = 0 													"
            + "  	and encounter.encounter_type = 18 															"
            + "  	and obs.concept_id =5096  																	"
            + " 	and encounter.location_id = :location 														"
            + "  	and obs.value_datetime is not null 															"
            + "  	and encounter.encounter_datetime <= :endDate 															"
            + "  	and encounter.patient_id in (:patientIds)  													"
            + "  	order by obs.obs_datetime desc  												";

    public static final String findNextScheduledConsultationEncountersByPatientsIdAndLocation =
        "			    "
            + " select encounter.patient_id, encounter.encounter_datetime, obs.value_datetime  				    "
            + " from encounter 																					"
            + "    join obs on obs.encounter_id = encounter.encounter_id 										"
            + "  where encounter.voided = 0 and obs.voided = 0 													"
            + "  	and encounter.encounter_type in (6,9) 														"
            + "  	and obs.concept_id =1410  																	"
            + " 	and encounter.location_id = :location 														"
            + "  	and obs.value_datetime is not null 															"
            + "  	and encounter.encounter_datetime <= :endDate 															"
            + "  	and encounter.patient_id in (:patientIds)  													"
            + "  	order by obs.obs_datetime desc  												";

    public static final String findPatientsWhoWhereTransferredOutByEndOfPreviousReportingPeriod =
        "select allSaida.patient_id "
            + "from ( "
            + "    select saidas_por_transferencia.patient_id, data_estado "
            + "    from( "
            + "            select saidas_por_transferencia.patient_id, max(data_estado) data_estado "
            + "            from "
            + "                ( "
            + "                  select distinct max_estado.patient_id, max_estado.data_estado "
            + "                  from "
            + "                    ( "
            + "                           select pg.patient_id, max(ps.start_date) data_estado "
            + "                           from patient p "
            + "                              inner join person pe on pe.person_id = p.patient_id "
            + "                                inner join patient_program pg on p.patient_id = pg.patient_id "
            + "                                inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
            + "                           where pg.voided=0 and ps.voided=0 and p.voided=0 and pe.voided = 0 and pg.program_id = 2 "
            + "                              and ps.start_date < :startDate and pg.location_id =:location group by pg.patient_id "
            + "                      ) max_estado "
            + "                          inner join patient_program pp on pp.patient_id = max_estado.patient_id "
            + "                          inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
            + "                      where pp.program_id = 2 and ps.state = 7 and pp.voided = 0 and ps.voided = 0 and pp.location_id = :location "
            + "                      union "
            + "                      select  p.patient_id,max(o.obs_datetime) data_estado "
            + "                      from patient p "
            + "                          inner join person pe on pe.person_id = p.patient_id "
            + "                            inner join encounter e on p.patient_id=e.patient_id "
            + "                            inner join obs  o on e.encounter_id=o.encounter_id "
            + "                      where e.voided=0 and o.voided=0 and p.voided=0 and pe.voided = 0 "
            + "                          and e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded = 1706 "
            + "                            and o.obs_datetime <:startDate and e.location_id=:location "
            + "                        group by p.patient_id "
            + "                         union "
            + "                        select ultimaBusca.patient_id, ultimaBusca.data_estado "
            + "                        from ( "
            + "                               select p.patient_id,max(e.encounter_datetime) data_estado "
            + "                               from patient p "
            + "                                   inner join person pe on pe.person_id = p.patient_id "
            + "                                   inner join encounter e on p.patient_id=e.patient_id "
            + "                                   inner join obs o on o.encounter_id=e.encounter_id "
            + "                               where e.voided=0 and p.voided=0 and pe.voided = 0 and e.encounter_datetime < :startDate "
            + "                                   and e.encounter_type = 21 and  e.location_id= :location "
            + "                                   group by p.patient_id "
            + "                           ) ultimaBusca "
            + "                               inner join encounter e on e.patient_id = ultimaBusca.patient_id "
            + "                               inner join obs o on o.encounter_id = e.encounter_id "
            + "                          where e.encounter_type = 21 and o.voided=0 and o.concept_id=2016 and o.value_coded in (1706,23863) and ultimaBusca.data_estado = e.encounter_datetime and e.location_id = :location "
            + "                ) saidas_por_transferencia group by patient_id "
            + "    ) saidas_por_transferencia "
            + "      left join "
            + "      ( "
            + "          select patient_id, max(data_ultimo_levantamento)  data_ultimo_levantamento "
            + "          from ( "
            + "          select ultimoFila.patient_id,obs_fila.value_datetime data_ultimo_levantamento  from( "
            + "        select p.patient_id, max(e.encounter_datetime) dataFila "
            + "        from patient p "
            + "          inner join encounter e on e.patient_id= p.patient_id "
            + "        where p.voided= 0 and e.voided=0 and e.encounter_type=18 "
            + "          and e.location_id=:location and e.encounter_datetime  < :startDate "
            + "          group by p.patient_id "
            + "          )ultimoFila "
            + "		inner join encounter e on e.patient_id=ultimoFila.patient_id "
            + "		inner join obs obs_fila on e.encounter_id = obs_fila.encounter_id "
            + "			where obs_fila.voided=0 "
            + "			and e.encounter_type=18 "
            + "			and e.location_id=:location "
            + "			and ultimoFila.dataFila = e.encounter_datetime "
            + "			and obs_fila.concept_id=5096 "
            + "        union "
            + "          select p.patient_id, date_add(max(value_datetime), interval 31 day) data_ultimo_levantamento "
            + "          from patient p "
            + "            inner join person pe on pe.person_id = p.patient_id "
            + "               inner join encounter e on p.patient_id=e.patient_id "
            + "               inner join obs o on e.encounter_id=o.encounter_id "
            + "          where p.voided=0 and pe.voided = 0 and e.voided=0 and o.voided=0 and e.encounter_type=52 "
            + "               and o.concept_id=23866 and o.value_datetime is not null and e.location_id=:location and o.value_datetime  < :startDate "
            + "          group by p.patient_id "
            + "            ) ultimo_levantamento group by patient_id "
            + "    ) ultimo_levantamento on saidas_por_transferencia.patient_id = ultimo_levantamento.patient_id "
            + ") allSaida "
            + "left join "
            + "( "
            + "  Select p.patient_id,max(encounter_datetime) max_date "
            + "  from    patient p "
            + "      inner join person pe on pe.person_id = p.patient_id "
            + "      inner join encounter e on e.patient_id=p.patient_id "
            + "  where   p.voided=0 and pe.voided = 0 and e.voided=0 and e.encounter_type=18 "
            + "      and e.location_id=:location  and e.encounter_datetime <= :startDate "
            + "    group by p.patient_id "
            + ") last_encounter on allSaida.patient_id  = last_encounter.patient_id "
            + "where allSaida.data_estado >= last_encounter.max_date ";
  }
}
