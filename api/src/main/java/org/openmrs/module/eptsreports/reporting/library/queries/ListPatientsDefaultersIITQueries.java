package org.openmrs.module.eptsreports.reporting.library.queries;

public interface ListPatientsDefaultersIITQueries {

  class QUERY {

    public static final String findPatientsDefaultersIITList =
        " 																	                            "
            + "             select 	coorte12meses_final.patient_id,                              "
            + "             		coorte12meses_final.data_inicio as art_start_date,                              "
            + "             		coorte12meses_final.data_usar_c ultimo_lev,                              "
            + "             		coorte12meses_final.data_usar proximo_marcado,                              "
            + "             		coorte12meses_final.data_estado,                              "
            + "             		coorte12meses_final.estado,                              "
            + "             		coorte12meses_final.data_fila as ultimoFila,                              "
            + "             		coorte12meses_final.data_proximo_lev as proximoLevantamentoFila,                              "
            + "             		coorte12meses_final.data_recepcao_levantou as ultimoLevantamentoMCard,                              "
            + "             		coorte12meses_final.data_recepcao_levantou30 as proximoLevantamentoMCard,		                              "
            + "             		datediff(:endDate,coorte12meses_final.data_usar) diasFalta,                              "
            + "             		pad3.county_district as 'distrito',                              "
            + "             		pad3.address2 as 'pAdministrativo',                              "
            + "             		pad3.address6 as 'localidade',                              "
            + "             		pad3.address5 as 'bairro',                              "
            + "             		pad3.address1 as 'pontoReferencia',                              "
            + "             		concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as 'nomeCompleto',                              "
            + "             		pid.identifier as nid,                              "
            + "             		p.gender,                              "
            + "             		round(datediff(:endDate,p.birthdate)/365) idadeActual,                              "
            + "             		pat.value as telefone,                              "
            + "             		estadoMulher.estadoMulher estadoMulher,                              "
            + "             		tb.temTB,                              "
            + "             		consentimentoPaciente.consente as consentimentoPaciente,                              "
            + "             		consentimentoConfidente.consente consentimentoConfidente,                              "
            + "             		dispensaTipo.tipoDispensa as tipoDispensa ,                               "
            + "             		consultaClinica.encounter_datetime ultimaConsulta,                              "
            + "             		consultaClinica.value_datetime proximaConsulta                              "
            + "             from                              "
            + "             (select   	inicio_fila_seg_prox.*,                              "
            + "             			GREATEST(COALESCE(data_fila,data_recepcao_levantou),COALESCE(data_recepcao_levantou,data_fila))  data_usar_c,                              "
            + "             GREATEST(COALESCE(data_proximo_lev,data_recepcao_levantou30),COALESCE(data_recepcao_levantou30,data_proximo_lev)) data_usar                              "
            + "             from                              "
            + "             (select 	inicio_fila_seg.*,                              "
            + "             		max(obs_fila.value_datetime) data_proximo_lev,                              "
            + "             		date_add(data_recepcao_levantou, interval 30 day) data_recepcao_levantou30                              "
            + "             from                              "
            + "             (select inicio.*,		                              "
            + "             		saida.data_estado,                              "
            + "             		saida.estado,                              "
            + "             		max_fila.data_fila,                              "
            + "             		max_recepcao.data_recepcao_levantou                              "
            + "             from                              "
            + "             (	Select patient_id,min(data_inicio) data_inicio                              "
            + "             		from                              "
            + "             			(	                              "
            + "             				Select 	p.patient_id,min(e.encounter_datetime) data_inicio                              "
            + "             				from 	patient p                               "
            + "             						inner join encounter e on p.patient_id=e.patient_id	                              "
            + "             						inner join obs o on o.encounter_id=e.encounter_id                              "
            + "             				where 	e.voided=0 and o.voided=0 and p.voided=0 and                               "
            + "             						e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and                               "
            + "             						e.encounter_datetime<=:endDate and e.location_id=:location                              "
            + "             				group by p.patient_id                              "
            + "             				union                              "
            + "             				Select 	p.patient_id,min(value_datetime) data_inicio                              "
            + "             				from 	patient p                              "
            + "             						inner join encounter e on p.patient_id=e.patient_id                              "
            + "             						inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and                               "
            + "             						o.concept_id=1190 and o.value_datetime is not null and                               "
            + "             						o.value_datetime<=:endDate and e.location_id=:location                              "
            + "             				group by p.patient_id                              "
            + "             				union                              "
            + "             				select 	pg.patient_id,min(date_enrolled) data_inicio                              "
            + "             				from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id                              "
            + "             				where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location                              "
            + "             				group by pg.patient_id                              "
            + "             				union                              "
            + "             				  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio                               "
            + "             				  FROM 		patient p                              "
            + "             							inner join encounter e on p.patient_id=e.patient_id                              "
            + "             				  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location                              "
            + "             				  GROUP BY 	p.patient_id                              "
            + "             			                                "
            + "             				union                              "
            + "             				Select 	p.patient_id,min(value_datetime) data_inicio                              "
            + "             				from 	patient p                              "
            + "             						inner join encounter e on p.patient_id=e.patient_id                              "
            + "             						inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and                               "
            + "             						o.concept_id=23866 and o.value_datetime is not null and                               "
            + "             						o.value_datetime<=:endDate and e.location_id=:location                              "
            + "             				group by p.patient_id	                              "
            + "                                           "
            + "             			) inicio_real                              "
            + "             		group by patient_id                              "
            + "             )inicio                              "
            + "             left join                              "
            + "             (                            "
            + "               select allSaida.patient_id, data_estado data_estado,estado                              "
            + "	             from(                            "
            + "	             	select patient_id,max(data_estado) data_estado,estado                              "
            + "	             	from                               "
            + "	             		(                              "
            + "							select distinct max_estado.patient_id,                               																					"
            + "								max_estado.data_estado,                               																								"
            + "								if(ps.state=7,'Transferido Para',if(ps.state=8,'Suspenso','Obito')) estado                              											"
            + "							from ( 																																					"
            + "								select pg.patient_id,                               																								"
            + "									max(ps.start_date) data_estado                               																					"
            + "								from patient p                                																										"
            + "									inner join patient_program pg on p.patient_id=pg.patient_id                               														"
            + "									inner join patient_state ps on pg.patient_program_id=ps.patient_program_id                               										"
            + "								where pg.voided=0 and ps.voided=0 and p.voided=0 and pg.program_id=2   																				"
            + "									and pg.location_id=:location and ps.start_date<= curdate() group by pg.patient_id 																	"
            + "								) 																																					"
            + "							max_estado                               																												"
            + "								inner join patient_program pp on pp.patient_id = max_estado.patient_id															 					"
            + "								inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado	        					"
            + "							where pp.program_id = 2 and ps.state in (7,8,10) and pp.voided = 0 and ps.voided = 0 and ps.start_date<= curdate() and pp.location_id = :location  and ps.end_date is null     	"
            + "	             			union                              "
            + "	             			select 	p.patient_id,                              "
            + "	             					max(o.obs_datetime) data_estado,                              "
            + "	             					if(o.value_coded=1706,'Transferido para',if(o.value_coded=1366,'Obito','Suspenso')) estado                              "
            + "	             			from 	patient p                               "
            + "	             					inner join encounter e on p.patient_id=e.patient_id                              "
            + "	             					inner join obs  o on e.encounter_id=o.encounter_id                              "
            + "	             			where 	e.voided=0 and o.voided=0 and p.voided=0 and                               "
            + "	             					e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and                                "
            + "	             					o.obs_datetime<= curdate() and e.location_id=:location                              "
            + "	             			group by p.patient_id                              "
            + "	             			union                              "
            + "	             			select person_id as patient_id,death_date as data_estado,'Obito' as estado                              "
            + "	             			from person                               "
            + "	             			where dead=1 and death_date is not null and death_date<= curdate()                              "
            + "	             			union                              "
            + "	             			select 	p.patient_id,                              "
            + "	             					max(obsObito.obs_datetime) data_estado,'Obito' as estado                               "
            + "	             			from 	patient p                               "
            + "	             					inner join encounter e on p.patient_id=e.patient_id                              "
            + "	             					inner join obs obsObito on e.encounter_id=obsObito.encounter_id                              "
            + "	             			where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and                               "
            + "	             					e.encounter_type in (21,36,37) and  e.encounter_datetime<= curdate() and  e.location_id=:location and                               "
            + "	             					obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366	                              "
            + "	             			group by p.patient_id                              "
            + "	             		) allSaida                              "
            + "	             	group by patient_id                            "
            + "	             	) allSaida 	                            "
            + "             	 inner join                                                                                                                     												                            "
            + "                     (                                                                                                                              												                            "
            + "                       select patient_id,max(encounter_datetime) encounter_datetime from                                                            												                            "
            + "                       (                                                                                                                            												                            "
            + "                           select p.patient_id,max(e.encounter_datetime) encounter_datetime from  patient p                                         												                            "
            + "                             inner join encounter e on e.patient_id=p.patient_id                                                                    												                            "
            + "                           where p.voided=0 and e.voided=0 and e.encounter_datetime<= curdate() and e.location_id=:location and e.encounter_type in (18,6,9) group by p.patient_id 				                            "
            + "                           union                                                                                                                    												                            "
            + "                           select p.patient_id,max(value_datetime) encounter_datetime from  patient p                                               												                            "
            + "                             inner join encounter e on p.patient_id=e.patient_id                                                                    												                            "
            + "                             inner join obs o on e.encounter_id=o.encounter_id                                                                      												                            "
            + "                           where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and o.concept_id=23866 and o.value_datetime is not null 										                            "
            + "                             and o.value_datetime<= curdate() and e.location_id=:location group by p.patient_id                                       												                            "
            + "                       ) consulta_levantamento group by patient_id                                                                                  												                            "
            + "                   ) all_consulta_levantamento on all_consulta_levantamento.patient_id = allSaida.patient_id                                      												                            "
            + "                 where all_consulta_levantamento.encounter_datetime <= allSaida.data_estado and allSaida.data_estado <= curdate()                                    "
            + "                            "
            + "             ) saida on inicio.patient_id=saida.patient_id                              "
            + "             left join                              "
            + "             (	Select 	p.patient_id,max(encounter_datetime) data_fila                              "
            + "             	from 	patient p                               "
            + "             			inner join encounter e on e.patient_id=p.patient_id                              "
            + "             	where 	p.voided=0 and e.voided=0 and e.encounter_type=18 and                               "
            + "             			e.location_id=:location and e.encounter_datetime<=:endDate                              "
            + "             	group by p.patient_id                              "
            + "             ) max_fila on inicio.patient_id=max_fila.patient_id	                              "
            + "             left join                              "
            + "             (                              "
            + "             	Select 	p.patient_id,max(value_datetime) data_recepcao_levantou                              "
            + "             	from 	patient p                              "
            + "             			inner join encounter e on p.patient_id=e.patient_id                              "
            + "             			inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and                               "
            + "             			o.concept_id=23866 and o.value_datetime is not null and                               "
            + "             			o.value_datetime<=:endDate and e.location_id=:location                              "
            + "             	group by p.patient_id                              "
            + "             ) max_recepcao on inicio.patient_id=max_recepcao.patient_id                              "
            + "             group by inicio.patient_id                              "
            + "             ) inicio_fila_seg                              "
            + "             left join                              "
            + "             	obs obs_fila on obs_fila.person_id=inicio_fila_seg.patient_id                              "
            + "             	and obs_fila.voided=0                              "
            + "             	and obs_fila.obs_datetime=inicio_fila_seg.data_fila                              "
            + "             	and obs_fila.concept_id=5096                              "
            + "             	and obs_fila.location_id=:location                              "
            + "             group by inicio_fila_seg.patient_id                              "
            + "             ) inicio_fila_seg_prox                              "
            + "             group by patient_id                              "
            + "             ) coorte12meses_final                              "
            + "             inner join person p on p.person_id=coorte12meses_final.patient_id                              "
            + "             left join                               "
            + "             (	select pad1.*                              "
            + "             	from person_address pad1                              "
            + "             	inner join                               "
            + "             	(                              "
            + "             		select person_id,min(person_address_id) id                               "
            + "             		from person_address                              "
            + "             		where voided=0                              "
            + "             		group by person_id                              "
            + "             	) pad2                              "
            + "             	where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id                              "
            + "             ) pad3 on pad3.person_id=coorte12meses_final.patient_id				                              "
            + "             left join 			                              "
            + "             (	select pn1.*                              "
            + "             	from person_name pn1                              "
            + "             	inner join                               "
            + "             	(                              "
            + "             		select person_id,min(person_name_id) id                               "
            + "             		from person_name                              "
            + "             		where voided=0                              "
            + "             		group by person_id                              "
            + "             	) pn2                              "
            + "             	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id                              "
            + "             ) pn on pn.person_id=coorte12meses_final.patient_id			                              "
            + "             left join                              "
            + "             (   select pid1.*                              "
            + "             	from patient_identifier pid1                              "
            + "             	inner join                              "
            + "             	(                              "
            + "             		select patient_id,min(patient_identifier_id) id                              "
            + "             		from patient_identifier                              "
            + "             		where voided=0                              "
            + "             		group by patient_id                              "
            + "             	) pid2                              "
            + "             	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id                              "
            + "             ) pid on pid.patient_id=coorte12meses_final.patient_id                              "
            + "             left join person_attribute pat on pat.person_id=coorte12meses_final.patient_id and pat.person_attribute_type_id=9 and pat.value is not null and pat.value<>'' and pat.voided=0                              "
            + "             left join                               "
            + "             (                              "
            + "             	select patient_id, if(decisao=1,'Lactante','Grávida') estadoMulher                              "
            + "             	from                               "
            + "             	(	select 	inicio_real.patient_id,                              "
            + "             				gravida_real.data_gravida,                              "
            + "             				lactante_real.data_parto,                              "
            + "             				if(max(gravida_real.data_gravida) is null and max(lactante_real.data_parto) is null,null,                              "
            + "             					if(max(gravida_real.data_gravida) is null,1,                              "
            + "             						if(max(lactante_real.data_parto) is null,2,                              "
            + "             							if(max(lactante_real.data_parto)>max(gravida_real.data_gravida),1,2)))) decisao                              "
            + "             		from                              "
            + "                                           "
            + "             		(	                              "
            + "             			select 	p.patient_id                               "
            + "             			from 	patient p inner join encounter e on e.patient_id=p.patient_id                               "
            + "             			where 	e.voided=0 and p.voided=0 and e.encounter_type in (5,7) and e.encounter_datetime<=curdate() and e.location_id = :location                              "
            + "             			union                              "
            + "             			select 	pg.patient_id                              "
            + "             			from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id                              "
            + "             			where 	pg.voided=0 and p.voided=0 and program_id in (1,2) and date_enrolled<=curdate() and location_id=:location                              "
            + "             			union                              "
            + "             			Select 	p.patient_id                              "
            + "             			from 	patient p                              "
            + "             					inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=53 and                               "
            + "             					o.concept_id=23891 and o.value_datetime is not null and                               "
            + "             					o.value_datetime<=curdate() and e.location_id=:location                              "
            + "             		)inicio_real                              "
            + "             		left join                               "
            + "             		(                              "
            + "             			Select 	p.patient_id,e.encounter_datetime data_gravida                              "
            + "             			from 	patient p                               "
            + "             					inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1982 and value_coded=1065 and                               "
            + "             					e.encounter_type in (5,6) and e.encounter_datetime  between (curdate() - interval 9 month) and curdate() and e.location_id=:location                              "
            + "             			union		                              "
            + "             			Select 	p.patient_id,e.encounter_datetime data_gravida                              "
            + "             			from 	patient p inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1279 and                               "
            + "             					e.encounter_type in (5,6) and e.encounter_datetime between (curdate() - interval 9 month) and curdate() and e.location_id=:location                              "
            + "             			union		                              "
            + "             			Select 	p.patient_id,e.encounter_datetime data_gravida                              "
            + "             			from 	patient p inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1600 and                               "
            + "             					e.encounter_type in (5,6) and e.encounter_datetime between (curdate() - interval 9 month) and curdate() and e.location_id=:location	                              "
            + "             			union                              "
            + "             			Select 	p.patient_id,e.encounter_datetime data_gravida                              "
            + "             			from 	patient p                               "
            + "             					inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6334 and value_coded=6331 and                               "
            + "             					e.encounter_type in (5,6) and e.encounter_datetime between (curdate() - interval 9 month) and curdate() and e.location_id=:location		                              "
            + "             			union                              "
            + "             			select 	pp.patient_id,pp.date_enrolled data_gravida                              "
            + "             			from 	patient_program pp                               "
            + "             			where 	pp.program_id=8 and pp.voided=0 and                               "
            + "             					pp.date_enrolled between (curdate() - interval 9 month) and curdate() and pp.location_id=:location                              "
            + "             			union		                              "
            + "             			Select 	p.patient_id,obsART.value_datetime data_gravida                              "
            + "             			from 	patient p                               "
            + "             					inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             					inner join obs obsART on e.encounter_id=obsART.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=1982 and o.value_coded=1065 and                               "
            + "             					e.encounter_type=53 and obsART.value_datetime between (curdate() - interval 9 month) and curdate() and e.location_id=:location and                               "
            + "             					obsART.concept_id=1190 and obsART.voided=0                              "
            + "             			union		                              "
            + "             			Select 	p.patient_id,e.encounter_datetime data_gravida                              "
            + "             			from 	patient p inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=1465 and                               "
            + "             					e.encounter_type=6 and e.encounter_datetime between (curdate() - interval 9 month) and curdate() and e.location_id=:location                              "
            + "             		) gravida_real on gravida_real.patient_id=inicio_real.patient_id                                "
            + "             		left join                               "
            + "             		(                              "
            + "             			Select 	p.patient_id,o.value_datetime data_parto                              "
            + "             			from 	patient p inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=5599 and                               "
            + "             					e.encounter_type in (5,6) and o.value_datetime between (curdate() - interval 18 month) and curdate() and e.location_id=:location	                              "
            + "             			union	                              "
            + "             			Select 	p.patient_id, e.encounter_datetime data_parto                              "
            + "             			from 	patient p                               "
            + "             					inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6332 and value_coded=1065 and                               "
            + "             					e.encounter_type=6 and e.encounter_datetime between (curdate() - interval 18 month) and curdate() and e.location_id=:location                              "
            + "             			union                              "
            + "             			Select 	p.patient_id, obsART.value_datetime data_parto                              "
            + "             			from 	patient p                               "
            + "             					inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             					inner join obs obsART on e.encounter_id=obsART.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=6332 and o.value_coded=1065 and                               "
            + "             					e.encounter_type=53 and e.location_id=:location and                               "
            + "             					obsART.value_datetime between (curdate() - interval 18 month) and curdate() and                               "
            + "             					obsART.concept_id=1190 and obsART.voided=0                              "
            + "             			union                              "
            + "             			Select 	p.patient_id, e.encounter_datetime data_parto                              "
            + "             			from 	patient p                               "
            + "             					inner join encounter e on p.patient_id=e.patient_id                              "
            + "             					inner join obs o on e.encounter_id=o.encounter_id                              "
            + "             			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6334 and value_coded=6332 and                               "
            + "             					e.encounter_type in (5,6) and e.encounter_datetime between (curdate() - interval 18 month) and curdate() and e.location_id=:location                              "
            + "             			union		                              "
            + "             			select 	pg.patient_id,ps.start_date data_parto                              "
            + "             			from 	patient p                               "
            + "             					inner join patient_program pg on p.patient_id=pg.patient_id                              "
            + "             					inner join patient_state ps on pg.patient_program_id=ps.patient_program_id                              "
            + "             			where 	pg.voided=0 and ps.voided=0 and p.voided=0 and                               "
            + "             					pg.program_id=8 and ps.state=27 and                               "
            + "             					ps.start_date between (curdate() - interval 18 month) and curdate() and location_id=:location                              "
            + "             				                              "
            + "             		) lactante_real on lactante_real.patient_id=inicio_real.patient_id                              "
            + "             	where 	lactante_real.data_parto is not null or gravida_real.data_gravida is not null                              "
            + "             		group by inicio_real.patient_id                              "
            + "             		                              "
            + "             	) gravidaLactante		                              "
            + "             	inner join person pe on pe.person_id=gravidaLactante.patient_id		                              "
            + "             	where pe.voided=0 and pe.gender='F'                              "
            + "             ) estadoMulher on estadoMulher.patient_id=coorte12meses_final.patient_id                              "
            + "             left join                              "
            + "             (                              "
            + "                 SELECT 	p.patient_id,'S' temTB                               "
            + "             	FROM 	patient p                              "
            + "             			INNER JOIN encounter e ON e.patient_id = p.patient_id                              "
            + "             			INNER JOIN obs o ON o.encounter_id = e.encounter_id                              "
            + "                 WHERE 	p.voided = 0 AND e.voided = 0 AND o.voided = 0                              "
            + "                         AND e.encounter_type=6                              "
            + "                         AND o.concept_id = 1268                              "
            + "                         AND o.value_coded=1256                              "
            + "                         AND e.location_id = :location AND o.obs_datetime between (curdate() - interval 7 month) and curdate()                               "
            + "                 GROUP BY p.patient_id                              "
            + "             	UNION                              "
            + "                 SELECT 	p.patient_id,'S' temTB                               "
            + "             	FROM 	patient p                              "
            + "             			INNER JOIN encounter e ON e.patient_id = p.patient_id                              "
            + "             			INNER JOIN obs o ON o.encounter_id = e.encounter_id                              "
            + "                 WHERE 	p.voided = 0 AND e.voided = 0 AND o.voided = 0                              "
            + "                         AND e.encounter_type IN (6,9)                              "
            + "                         AND o.concept_id = 1113                              "
            + "                         AND e.location_id = :location AND o.value_datetime between (curdate() - interval 7 month) and curdate()                               "
            + "                 GROUP BY p.patient_id                              "
            + "             	UNION                              "
            + "             	SELECT 	p.patient_id,'S' temTB                               "
            + "             	FROM 	patient p                              "
            + "             			INNER JOIN encounter e ON e.patient_id = p.patient_id                              "
            + "             			INNER JOIN obs o ON o.encounter_id = e.encounter_id                              "
            + "                 WHERE 	p.voided = 0 AND e.voided = 0 AND o.voided = 0                              "
            + "                         AND e.encounter_type=53                              "
            + "                         AND o.concept_id = 42                              "
            + "                         AND o.value_coded=1065                              "
            + "                         AND e.location_id = :location AND o.obs_datetime between (curdate() - interval 7 month) and curdate()                               "
            + "                 GROUP BY p.patient_id                              "
            + "             	UNION                              "
            + "             	  SELECT 	p.patient_id,'S' temTB                               "
            + "             	FROM 	patient p                              "
            + "             			INNER JOIN patient_program pg ON pg.patient_id = p.patient_id                              "
            + "                 WHERE 	p.voided = 0 AND pg.voided = 0                              "
            + "                         AND pg.program_id = 5                               "
            + "                         AND pg.date_enrolled BETWEEN (curdate() - interval 7 month) and curdate() AND pg.location_id = :location                              "
            + "                 GROUP BY p.patient_id                              "
            + "             	UNION                              "
            + "             	SELECT 	p.patient_id,'S' temTB                               "
            + "             	FROM 	patient p                              "
            + "             			INNER JOIN encounter e ON e.patient_id = p.patient_id                              "
            + "             			INNER JOIN obs o ON o.encounter_id = e.encounter_id                              "
            + "                 WHERE 	p.voided = 0 AND e.voided = 0 AND o.voided = 0                              "
            + "                         AND e.encounter_type=6                              "
            + "                         AND o.concept_id = 23761                              "
            + "                         AND o.value_coded=1065                              "
            + "                         AND e.location_id = :location AND e.encounter_datetime between (curdate() - interval 7 month) and curdate()                               "
            + "                 GROUP BY p.patient_id                              "
            + "             ) tb on tb.patient_id=coorte12meses_final.patient_id                              "
            + "             left join                          																																					                              "
            + "             (                         																																							                              "
            + "             select maxConsent.patient_id,if(o.value_coded=1065,'S','N') consente                         																					                              "
            + "             from                          																																					                              "
            + "             (                         																																						                              "
            + "               select p.patient_id,max(e.encounter_datetime) dataConsentimento                         																						                              "
            + "               from  patient p                          																																		                              "
            + "                   inner join encounter e on p.patient_id=e.patient_id                         																								                              "
            + "                   inner join obs o on o.encounter_id=e.encounter_id                         																									                              "
            + "               where   p.voided=0 and e.voided=0 and o.voided=0 and                         																									                              "
            + "                   e.encounter_datetime<=curdate() and e.encounter_type=35 and e.location_id=:location and                           															                              "
            + "                   o.concept_id=6306                          																																	                              "
            + "               group by p.patient_id                         																																	                              "
            + "             )maxConsent                         																																				                              "
            + "             inner join encounter e on e.patient_id=maxConsent.patient_id                         																								                              "
            + "             inner join obs o on o.encounter_id=e.encounter_id                         																										                              "
            + "             where e.voided=0 and o.voided=0 and                          																														                              "
            + "                 e.encounter_type=35 and e.location_id=:location and                          																									                              "
            + "                 e.encounter_datetime=maxConsent.dataConsentimento and                          																								                              "
            + "                 o.concept_id=6306                          																																	                              "
            + "             ) consentimentoPaciente on coorte12meses_final.patient_id = consentimentoPaciente.patient_id                         																		                              "
            + "             left join                          																																					                              "
            + "             (                         																																							                              "
            + "             select maxConsent.patient_id,if(o.value_coded=1065,'S','N') consente                         																					                              "
            + "             from                          																																					                              "
            + "             (                         																																						                              "
            + "               select p.patient_id,max(e.encounter_datetime) dataConsentimento                         																						                              "
            + "               from  patient p                          																																		                              "
            + "                   inner join encounter e on p.patient_id=e.patient_id                         																								                              "
            + "                   inner join obs o on o.encounter_id=e.encounter_id                         																									                              "
            + "               where   p.voided=0 and e.voided=0 and o.voided=0 and                         																									                              "
            + "                   e.encounter_datetime<=curdate() and e.encounter_type=35 and e.location_id=:location and                           															                              "
            + "                   o.concept_id=6177                          																																	                              "
            + "               group by p.patient_id                         																																	                              "
            + "             )maxConsent                         																																				                              "
            + "             inner join encounter e on e.patient_id=maxConsent.patient_id                         																								                              "
            + "             inner join obs o on o.encounter_id=e.encounter_id                         																										                              "
            + "             where e.voided=0 and o.voided=0 and                          																														                              "
            + "                 e.encounter_type=35 and e.location_id=:location and                          																									                              "
            + "                 e.encounter_datetime=maxConsent.dataConsentimento and                          																								                              "
            + "                 o.concept_id=6177                          																																	                              "
            + "             ) consentimentoConfidente on coorte12meses_final.patient_id = consentimentoConfidente.patient_id                                   "
            + "                                           "
            + "             left join                               "
            + "             (                              "
            + "             	select patient_id,tipoDispensa                              "
            + "             	from                               "
            + "             	(                              "
            + "             	select *                              "
            + "             	from                               "
            + "             	(                                          "
            + "             		select levantamento.patient_id,                              "
            + "             				levantamento.data_levantamento,                              "
            + "             				1 source,                              "
            + "             				if(datediff(o.value_datetime,levantamento.data_levantamento)<83,'DM',                              "
            + "             					if(datediff(o.value_datetime,levantamento.data_levantamento) between 83 and 173,'DT','DS')) tipoDispensa                              "
            + "             		from                               "
            + "             		(                               "
            + "             			select p.patient_id,max(e.encounter_datetime) data_levantamento                               "
            + "             			from 	patient p                               "
            + "             					inner join encounter e on p.patient_id=e.patient_id                               "
            + "             			where 	p.voided=0 and e.voided=0 and e.encounter_type=18 and date(e.encounter_datetime)<=:endDate                               "
            + "             					and e.location_id=:location                               "
            + "             			group by p.patient_id                               "
            + "             		)levantamento                               "
            + "             		inner join encounter e on e.patient_id = levantamento.patient_id                               "
            + "             		inner join obs o on o.encounter_id=e.encounter_id                               "
            + "             		where 	levantamento.data_levantamento=e.encounter_datetime and o.concept_id=5096 and                               "
            + "             				e.encounter_type=18 and e.voided=0 and o.voided=0 and e.location_id=:location                                "
            + "             		union                               "
            + "             		select 	max_tl.patient_id,                              "
            + "             				max_tl.max_datatl,                              "
            + "             				2 source,                              "
            + "             				if(obs.value_coded=1098,'DM',                              "
            + "             					if(obs.value_coded=23720,'DT','DS')) tipoDispensa                              "
            + "             		from                               "
            + "             		(                               "
            + "             		select 	p.patient_id,max(o.obs_datetime) max_datatl                               "
            + "             		from 	patient p                               "
            + "             				inner join encounter e on p.patient_id=e.patient_id                               "
            + "             				inner join obs o on o.encounter_id=e.encounter_id                               "
            + "             		where 	e.encounter_type=6 and e.voided=0 and o.voided=0 and p.voided=0 and                               "
            + "             				o.concept_id=23739 and e.location_id=:location and o.obs_datetime<=:endDate                               "
            + "             		group by p.patient_id                              "
            + "             		) max_tl                               "
            + "             		inner join obs on obs.person_id=max_tl.patient_id and max_tl.max_datatl=obs.obs_datetime                               "
            + "             		where obs.concept_id=23739 and obs.voided=0 and obs.location_id=:location                               "
            + "             		union                               "
            + "             		select 	max_dt.patient_id,                              "
            + "             				max_dt.max_datadt,                              "
            + "             				2 source,                              "
            + "             				'DT' tipoDispensa                              "
            + "             		from                               "
            + "             		(                               "
            + "             			select	 p.patient_id,max(o.obs_datetime) max_datadt                               "
            + "             			from 	patient p                               "
            + "             					inner join encounter e on p.patient_id=e.patient_id                               "
            + "             					inner join obs o on o.encounter_id=e.encounter_id                               "
            + "             			where 	e.encounter_type=6 and e.voided=0 and o.voided=0 and p.voided=0 and o.concept_id=23730 and                               "
            + "             					e.location_id=:location and o.obs_datetime<=:endDate                               "
            + "             			group by p.patient_id                               "
            + "             		) max_dt                               "
            + "             		inner join encounter e on e.patient_id=max_dt.patient_id                               "
            + "             		inner join obs on obs.encounter_id=e.encounter_id                               "
            + "             		where 	max_dt.max_datadt=obs.obs_datetime and obs.concept_id=23730 and obs.value_coded in (1256,1257) and                               "
            + "             				obs.voided=0 and obs.location_id=:location and e.encounter_type=6 and e.voided=0                               "
            + "             		union                               "
            + "             		                              "
            + "             		select 	max_dt.patient_id,                              "
            + "             				max_dt.max_datadt,                              "
            + "             				2 source,                              "
            + "             				'DS' tipoDispensa                              "
            + "             		from                               "
            + "             		(                               "
            + "             			select	 p.patient_id,max(o.obs_datetime) max_datadt                               "
            + "             			from 	patient p                               "
            + "             					inner join encounter e on p.patient_id=e.patient_id                               "
            + "             					inner join obs o on o.encounter_id=e.encounter_id                               "
            + "             			where 	e.encounter_type=6 and e.voided=0 and o.voided=0 and p.voided=0 and o.concept_id=23888 and                               "
            + "             					e.location_id=:location and o.obs_datetime<=:endDate                               "
            + "             			group by p.patient_id                               "
            + "             		) max_dt                               "
            + "             		inner join encounter e on e.patient_id=max_dt.patient_id                               "
            + "             		inner join obs on obs.encounter_id=e.encounter_id                               "
            + "             		where 	max_dt.max_datadt=obs.obs_datetime and obs.concept_id=23888 and obs.value_coded in (1256,1257) and                               "
            + "             				obs.voided=0 and obs.location_id=:location and e.encounter_type=6 and e.voided=0                               "
            + "             	)dispensa                              "
            + "             	order by patient_id,data_levantamento desc,source                              "
            + "             	)dispensafinal                              "
            + "             	group by patient_id                              "
            + "             ) dispensaTipo on dispensaTipo.patient_id=coorte12meses_final.patient_id                              "
            + "             left join                               "
            + "             (                              "
            + "             	Select 	ultimavisita.patient_id,ultimavisita.encounter_datetime,o.value_datetime                               "
            + "             	from                              "
            + "             		(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime                              "
            + "             			from 	encounter e                               "
            + "             					inner join patient p on p.patient_id=e.patient_id 		                              "
            + "             			where 	e.voided=0 and p.voided=0 and e.encounter_type in (6,9) and                               "
            + "             					e.location_id=:location and e.encounter_datetime<=:endDate                              "
            + "             			group by p.patient_id                              "
            + "             		) ultimavisita                              "
            + "             		inner join encounter e on e.patient_id=ultimavisita.patient_id                              "
            + "             		left join obs o on o.encounter_id=e.encounter_id and o.concept_id=1410 and o.voided=0			                              "
            + "             	where  	e.encounter_datetime=ultimavisita.encounter_datetime and                               "
            + "             			e.encounter_type in (6,9) and e.location_id=:location                               "
            + "             	group by ultimavisita.patient_id                              "
            + "                                           "
            + "             ) consultaClinica on consultaClinica.patient_id=coorte12meses_final.patient_id                              "
            + "             where (data_estado is null or (data_estado is not null and  data_usar_c>data_estado)) and                               "
            + "             		datediff(:endDate,data_usar)>=3 and datediff(:endDate,data_usar) between :minDelayDays AND :maxDelayDays "
            + "             group by coorte12meses_final.patient_id      												";

    public static final String findPatientsDefaultersIIT =
        "  select inicio.patient_id from                                                                                                "
            + " (                                                                                                                                      												"
            + "   select art_started.patient_id, art_started .art_start_date from                                                                      												"
            + "   (                                                                                                                                    												"
            + "       select patient_id, art_start_date from                                                                                           												"
            + "       (                                                                                                                                												"
            + "           select patient_id, min(art_start_date) art_start_date from                                                                   												"
            + "           (                                                                                                                            												"
            + "             select p.patient_id, min(e.encounter_datetime) art_start_date from patient p                                               												"
            + "               inner join encounter e on p.patient_id=e.patient_id                                                                      												"
            + "               inner join obs o on o.encounter_id=e.encounter_id                                                                        												"
            + "             where e.voided=0 and o.voided=0 and p.voided=0 and e.encounter_type in (18,6,9)                                            												"
            + "               and o.concept_id=1255 and o.value_coded=1256 and e.encounter_datetime<=:endDate and e.location_id=:location group by p.patient_id 									"
            + "             union                                                                                                                      												"
            + "             select p.patient_id, min(value_datetime) art_start_date from patient p inner join encounter e on p.patient_id=e.patient_id 												"
            + "               inner join obs o on e.encounter_id=o.encounter_id where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type IN (18,6,9,53) 									"
            + "               and o.concept_id=1190 and o.value_datetime is not null and o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id 								"
            + "             union                                                                                                                      												"
            + "             select pg.patient_id, min(date_enrolled) art_start_date from patient p                                                     												"
            + "               inner join patient_program pg on p.patient_id=pg.patient_id                                                              												"
            + "             where pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location group by pg.patient_id 											"
            + "             union                                                                                                                      												"
            + "             select e.patient_id, min(e.encounter_datetime) AS art_start_date from patient p                                            												"
            + "               inner join encounter e on p.patient_id=e.patient_id                                                                      												"
            + "             where p.voided=0 and e.encounter_type=18 and e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location group by p.patient_id 							"
            + "             union                                                                                                                      												"
            + "             select p.patient_id, min(value_datetime) art_start_date from patient p                                                     												"
            + "               inner join encounter e on p.patient_id=e.patient_id                                                                      												"
            + "               inner join obs o on e.encounter_id=o.encounter_id                                                                        												"
            + "             where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52                                                     												"
            + "               and o.concept_id=23866 and o.value_datetime is not null and o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id 								"
            + "           ) art_start group by patient_id                                                                                              												"
            + "     ) tx_new where art_start_date  <= :endDate                                                                                         												"
            + "       union                                                                                                                            												"
            + "       select state_transferred_in.patient_id,art_start_date from                                                                       												"
            + "       (                                                                                                                                												"
            + "           select p.patient_id, pg.patient_program_id, ps.start_date as art_start_date  from patient p                                  												"
            + "               inner join patient_program pg on p.patient_id=pg.patient_id                                                              												"
            + "                 inner join patient_state ps on pg.patient_program_id=ps.patient_program_id                                             												"
            + "           where pg.voided=0 and ps.voided=0 and p.voided=0 and pg.program_id=2 and location_id=:location  and ps.start_date <= :endDate 											"
            + "           group by pg.patient_program_id                                                                                               												"
            + "       ) state_transferred_in                                                                                                           												"
            + "         inner join patient_state ps on ps.patient_program_id=state_transferred_in.patient_program_id                                   												"
            + "       where ps.start_date=state_transferred_in.art_start_date and ps.state=29 and ps.voided=0                                          												"
            + "       union                                                                                                                            												"
            + "     select state_transferred_in.patient_id, art_start_date from                                                                        												"
            + "       (                                                                                                                                												"
            + "           select p.patient_id, obsdata.value_datetime art_start_date from patient p                                                    												"
            + "             inner join encounter e on p.patient_id=e.patient_id                                                                        												"
            + "             inner join obs obstrans on e.encounter_id=obstrans.encounter_id and obstrans.voided=0 and obstrans.concept_id=1369 and obstrans.value_coded=1065 						"
            + "             inner join obs obstarv on e.encounter_id=obstarv.encounter_id and obstarv.voided=0 and obstarv.concept_id=6300 and obstarv.value_coded=6276  							"
            + "             inner join obs obsdata on e.encounter_id=obsdata.encounter_id and obsdata.voided=0 and obsdata.concept_id=23891             											"
            + "         where p.voided=0 and e.voided=0 and e.encounter_type=53 and obsdata.value_datetime <= :endDate  and e.location_id=:location group by p.patient_id 							"
            + "       ) state_transferred_in group by state_transferred_in.patient_id                                                                  												"
            + "   ) art_started                                                                                                                        												"
            + "   left join                                                                                                                            												"
            + "   (                                                                                                                                    												"
            + "     select all_saidas.patient_id , all_saidas.data_estado from                                                                         												"
            + "     (                                                                                                                                  												"
            + "       select patient_id,max(data_estado) data_estado from                                                                              												"
            + "       (                                                                                                                                												"
            + "					select distinct max_estado.patient_id,                               																															"
            + "							max_estado.data_estado		                               																								"
            + "							from ( 																																					"
            + "								select pg.patient_id,                               																								"
            + "									max(ps.start_date) data_estado                               																					"
            + "								from patient p                                																										"
            + "									inner join patient_program pg on p.patient_id=pg.patient_id                               														"
            + "									inner join patient_state ps on pg.patient_program_id=ps.patient_program_id                               										"
            + "								where pg.voided=0 and ps.voided=0 and p.voided=0 and pg.program_id=2   																				"
            + "									and pg.location_id=:location and ps.start_date<= curdate() group by pg.patient_id 																	"
            + "								) 																																					"
            + "							max_estado                               																												"
            + "								inner join patient_program pp on pp.patient_id = max_estado.patient_id															 					"
            + "								inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado	        					"
            + "							where pp.program_id = 2 and ps.state in (7,8,10) and pp.voided = 0 and ps.voided = 0 and ps.start_date<= curdate() and pp.location_id = :location  and ps.end_date is null     	"
            + "               union                                                                                                                    												"
            + "               select p.patient_id, max(o.obs_datetime) data_estado from patient p                                                      												"
            + "                   inner join encounter e on p.patient_id=e.patient_id                                                                  												"
            + "                   inner join obs  o on e.encounter_id=o.encounter_id                                                                   												"
            + "               where e.voided=0 and o.voided=0 and p.voided=0 and e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) 					"
            + "                 and o.obs_datetime<= curdate() and e.location_id=:location group by p.patient_id                                         												"
            + "               union                                                                                                                    												"
            + "               select person_id as patient_id,death_date as data_estado from person                                                     												"
            + "               where dead=1 and death_date is not null and death_date<= curdate()                                                         												"
            + "               union                                                                                                                    												"
            + "               select  p.patient_id,max(obsObito.obs_datetime) data_estado from  patient p                                              												"
            + "                   inner join encounter e on p.patient_id=e.patient_id                                                                  												"
            + "                   inner join obs obsObito on e.encounter_id=obsObito.encounter_id                                                      												"
            + "               where e.voided=0 and p.voided=0 and obsObito.voided=0 and e.encounter_type in (21,36,37) and  e.encounter_datetime<= curdate() and e.location_id=:location 				"
            + "                 and obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366 group by p.patient_id                      												"
            + "               union                                                                                                                    												"
            + "               select  p.patient_id,max(e.encounter_datetime) data_estado from  patient p                                               												"
            + "                   inner join encounter e on p.patient_id=e.patient_id                                                                  												"
            + "                   inner join obs o on o.encounter_id=e.encounter_id                                                                    												"
            + "               where e.voided=0 and p.voided=0 and e.encounter_datetime<= curdate() and o.voided=0 and o.concept_id=2016                  												"
            + "                 and o.value_coded in (1706,23863) and e.encounter_type in (21,36,37) and  e.location_id=:location group by p.patient_id 											"
            + "           ) all_saidas  group by patient_id                                                                                            												"
            + "         ) all_saidas                                                                                                                   												"
            + "         inner join                                                                                                                     												"
            + "         (                                                                                                                              												"
            + "           select patient_id,max(encounter_datetime) encounter_datetime from                                                            												"
            + "           (                                                                                                                            												"
            + "               select p.patient_id,max(e.encounter_datetime) encounter_datetime from  patient p                                         												"
            + "                 inner join encounter e on e.patient_id=p.patient_id                                                                    												"
            + "               where p.voided=0 and e.voided=0 and e.encounter_datetime<= curdate() and e.location_id=:location and e.encounter_type in (18,6,9) group by p.patient_id 				"
            + "               union                                                                                                                    												"
            + "               select p.patient_id,max(value_datetime) encounter_datetime from  patient p                                               												"
            + "                 inner join encounter e on p.patient_id=e.patient_id                                                                    												"
            + "                 inner join obs o on e.encounter_id=o.encounter_id                                                                      												"
            + "               where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and o.concept_id=23866 and o.value_datetime is not null 										"
            + "                 and o.value_datetime<= curdate() and e.location_id=:location group by p.patient_id                                       												"
            + "           ) consulta_levantamento group by patient_id                                                                                  												"
            + "       ) all_consulta_levantamento on all_consulta_levantamento.patient_id = all_saidas.patient_id                                      												"
            + "     where all_consulta_levantamento.encounter_datetime <= all_saidas.data_estado and all_saidas.data_estado <= curdate()                												"
            + "                                                                                                                                        												"
            + "   ) saidas on saidas.patient_id = art_started.patient_id                                                                               												"
            + "   where saidas.data_estado is null or( saidas.data_estado is not null and saidas.data_estado < art_started.art_start_date)             												"
            + " ) inicio                                                                                                                               												"
            + " inner join                                                                                                                             												"
            + " (                                                                                                                                      												"
            + "   select patient_id, max(encounter_datetime) encounter_datetime from                                                                   												"
            + "   (                                                                                                                                    												"
            + "     select patient_id, max(encounter_datetime) encounter_datetime from                                                                 												"
            + "     (                                                                                                                                  												"
            + "         select last_fila.patient_id, next_fila.value_datetime encounter_datetime from                                                  												"
            + "         (                                                                                                                              												"
            + "             select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p                                            												"
            + "               inner join encounter e on e.patient_id=p.patient_id                                                                      												"
            + "             where p.voided=0 and e.voided=0 and e.encounter_type = 18 and e.encounter_datetime<=:endDate and e.location_id=:location   												"
            + "               group by p.patient_id                                                                                                    												"
            + "         ) last_fila                                                                                                                    												"
            + "             inner join encounter e on e.patient_id = last_fila.patient_id and e.encounter_datetime = last_fila.encounter_datetime      												"
            + "             left join obs next_fila on next_fila.encounter_id = e.encounter_id                                                          											"
            + "         where  e.voided = 0 and next_fila.voided = 0 and e.encounter_type =18 and e.encounter_datetime = last_fila.encounter_datetime  												"
            + "             and next_fila.concept_id = 5096 and next_fila.value_datetime is not null                                                   												"
            + "           union                                                                                                                        												"
            + "         select levantamento_master_card.patient_id, DATE_ADD(levantamento_master_card.encounter_datetime, INTERVAL 30 DAY) encounter_datetime  from 								"
            + "         (                                                                                                                              												"
            + "             select p.patient_id,max(data_levantamento_arv.value_datetime) encounter_datetime from patient p                            												"
            + "                 inner join encounter e on p.patient_id=e.patient_id                                                                    												"
            + "                 left join obs data_levantamento_arv on data_levantamento_arv.encounter_id = e.encounter_id                            												"
            + "               where p.voided=0 and e.voided=0 and data_levantamento_arv.voided=0 and e.encounter_type=52 and data_levantamento_arv.concept_id=23866 								"
            + "                 and data_levantamento_arv.value_datetime is not null and e.location_id=:location                                       												"
            + "                 and data_levantamento_arv.value_datetime <= :endDate group by p.patient_id                                             												"
            + "         ) levantamento_master_card                                                                                                     												"
            + "     ) all_levantamentos  group by all_levantamentos.patient_id                                                                         												"
            + "   )all_levantamentos                                                                                                                   												"
            + "   where (TIMESTAMPDIFF(DAY,all_levantamentos.encounter_datetime,:endDate)) BETWEEN :minDelayDays AND :maxDelayDays group by all_levantamentos.patient_id 							"
            + " ) iit_patients on iit_patients.patient_id = inicio.patient_id                                                                             											";
  }
}
