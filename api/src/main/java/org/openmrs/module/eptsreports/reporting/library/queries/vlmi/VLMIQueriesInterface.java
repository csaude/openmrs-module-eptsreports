package org.openmrs.module.eptsreports.reporting.library.queries.vlmi;

public interface VLMIQueriesInterface {

  class QUERY {

    public static final String
        findPatientsWhoWhereMarkedAsTransferedInAndOnARTOnInAPeriodOnMasterCardVLFR4 =
            "SELECT p.patient_id from patient p "
                + "INNER JOIN encounter e ON p.patient_id=e.patient_id "
                + "INNER JOIN obs obsTrans ON e.encounter_id=obsTrans.encounter_id AND obsTrans.voided=0 AND obsTrans.concept_id=1369 AND obsTrans.value_coded=1065 "
                + "INNER JOIN obs obsTarv ON e.encounter_id=obsTarv.encounter_id AND obsTarv.voided=0 AND obsTarv.concept_id=6300 AND obsTarv.value_coded=6276 "
                + "WHERE p.voided=0 AND e.voided=0 AND e.encounter_type=53 AND  e.location_id=:location ";

    public static final String findPatientsWhoTransferedOutVLFR5 =
        "select saida.patient_id from ( "
            + "select p.patient_id, max(o.obs_datetime) data_estado from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs  o on e.encounter_id=o.encounter_id "
            + "where e.voided=0 and o.voided=0 and p.voided=0 and e.encounter_type in (53,6) and "
            + "o.concept_id in(6272,6273) and o.value_coded=1706 and o.obs_datetime<=:endRevisionDate and e.location_id=:location "
            + "group by p.patient_id "
            + ") saida "
            + "inner join ( "
            + "select patient_id,max(encounter_datetime) encounter_datetime from ( "
            + "select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
            + "inner join encounter e on e.patient_id=p.patient_id "
            + "where p.voided=0 and e.voided=0 and e.encounter_datetime<=:endRevisionDate and "
            + "e.location_id=:location and e.encounter_type=6 "
            + "group by p.patient_id "
            + "union "
            + "Select p.patient_id,max(o.value_datetime) encounter_datetime from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "inner join obs oLevantou on e.encounter_id=oLevantou.encounter_id "
            + "where  p.voided=0 and e.voided=0 and o.voided=0 and oLevantou.voided=0 and e.encounter_type=52 and o.concept_id=23866 and "
            + "o.value_datetime is not null and o.value_datetime<=:endRevisionDate and e.location_id=:location and "
            + "oLevantou.concept_id=23865 and oLevantou.value_coded=1065 "
            + "group by p.patient_id "
            + ") consultaLev "
            + "group by patient_id "
            + ") consultaOuARV on saida.patient_id=consultaOuARV.patient_id "
            + "where consultaOuARV.encounter_datetime<=saida.data_estado and saida.data_estado<=:endRevisionDate ";

    public static final String findAllPatientWhoAreDeadByEndOfRevisonPeriodVLFR6 =
        " select obito.patient_id from ( "
            + " select patient_id, max(data_obito) data_obito from ( "
            + " select maxEstado.patient_id,maxEstado.data_obito from ( "
            + " select pg.patient_id, max(ps.start_date) data_obito from patient p "
            + " inner join patient_program pg on p.patient_id = pg.patient_id "
            + " inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
            + " where pg.voided = 0 and ps.voided = 0 and p.voided = 0 and "
            + " pg.program_id = 2 and DATE(ps.start_date) <= :endRevisionDate and pg.location_id = :location "
            + " group by p.patient_id "
            + ") maxEstado "
            + " inner join patient_program pg2 on pg2.patient_id = maxEstado.patient_id "
            + " inner join patient_state ps2 on pg2.patient_program_id = ps2.patient_program_id "
            + " where pg2.voided = 0 and ps2.voided = 0 and pg2.program_id = 2 and "
            + " ps2.start_date = maxEstado.data_obito and pg2.location_id = :location and ps2.state = 10 and ps2.end_date is null "
            + " union "
            + " select p.patient_id, max(e.encounter_datetime) data_obito from "
            + " patient p "
            + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + " INNER JOIN obs o on o.encounter_id = e.encounter_id "
            + " WHERE e.voided = 0 and p.voided = 0 and o.voided = 0 and e.encounter_type = 21 and e.location_id = :location "
            + " AND o.concept_id in (2031,23944,23945) and o.value_coded = 1366 and DATE(e.encounter_datetime) <= :endRevisionDate "
            + " group by p.patient_id "
            + " UNION "
            + " select p.patient_id, max(o.obs_datetime) data_obito from patient p "
            + " inner join encounter e on p.patient_id = e.patient_id "
            + " inner join obs o on o.encounter_id = e.encounter_id "
            + " where e.voided = 0 and p.voided = 0 and DATE(o.obs_datetime) <= :endRevisionDate and "
            + " o.voided = 0 and o.concept_id = 6272 and o.value_coded = 1366 and e.encounter_type = 53 and  e.location_id = :location "
            + " group by p.patient_id "
            + " union "
            + " select p.patient_id, max(e.encounter_datetime) data_obito from patient p "
            + " inner join encounter e on p.patient_id = e.patient_id "
            + " inner join obs o on o.encounter_id = e.encounter_id where e.voided = 0 and p.voided = 0 and DATE(e.encounter_datetime) <= :endRevisionDate "
            + " and o.voided = 0 and o.concept_id = 6273 and o.value_coded = 1366 and e.encounter_type = 6 and  e.location_id = :location "
            + " group by p.patient_id "
            + " union "
            + " Select person_id, death_date from person p where p.dead = 1 and DATE(p.death_date) <= :endRevisionDate) transferido "
            + " group by patient_id) obito "
            + " inner join ( "
            + " select patient_id, max(encounter_datetime) encounter_datetime from ( "
            + " select p.patient_id, max(e.encounter_datetime) encounter_datetime from patient p "
            + " inner join encounter e on e.patient_id = p.patient_id "
            + " where p.voided = 0 and e.voided = 0 and e.encounter_type in (18,6,9)  and DATE(e.encounter_datetime) <= :endRevisionDate and e.location_id = :location "
            + " group by p.patient_id "
            + " union "
            + " select p.patient_id, max(value_datetime) encounter_datetime from patient p "
            + " inner join encounter e on p.patient_id = e.patient_id "
            + " inner join obs o on e.encounter_id = o.encounter_id "
            + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 52 and "
            + " o.concept_id = 23866 and o.value_datetime <> 0 and o.value_datetime is not null and DATE(o.value_datetime) <= :endRevisionDate and e.location_id = :location "
            + " group by p.patient_id ) consultaLev "
            + " group by patient_id ) "
            + " consultaOuARV on obito.patient_id = consultaOuARV.patient_id "
            + " where consultaOuARV.encounter_datetime <= obito.data_obito and DATE(obito.data_obito) between :startInclusionDate AND :endRevisionDate ";

    public static final String findPatientsWhoArePregnantInclusionDateVLFR7 =
        " SELECT tx_new.patient_id FROM ( "
            + " SELECT patient_id, MIN(art_start_date) art_start_date FROM ( "
            + " SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p "
            + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + " INNER JOIN obs o ON e.encounter_id = o.encounter_id "
            + " WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND e.encounter_type = 53 "
            + " AND o.concept_id = 1190 AND o.value_datetime is NOT NULL AND o.value_datetime <= :endInclusionDate AND e.location_id = :location "
            + " GROUP BY p.patient_id "
            + " ) art_start "
            + " GROUP BY patient_id "
            + " ) tx_new "
            + " INNER JOIN "
            + " ( "
            + "	Select 	p.patient_id,obsART.value_datetime data_gravida "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join person pe ON pe.person_id = e.patient_id and pe.gender = 'F' "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "					inner join obs obsART on e.encounter_id=obsART.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=1982 and o.value_coded=1065 and "
            + "					e.encounter_type=53 and e.location_id=:location and "
            + "					obsART.concept_id=1190 and obsART.voided=0 "
            + "					and e.encounter_datetime between :startInclusionDate and :endInclusionDate "
            + " ) gravida ON gravida.patient_id = tx_new.patient_id "
            + " WHERE gravida.data_gravida <= tx_new.art_start_date  and tx_new.art_start_date between :startInclusionDate and :endInclusionDate ";

    public static final String findPatientsWhoAreBreastfeedingVLFR8 =
        " SELECT tx_new.patient_id FROM ( "
            + " SELECT patient_id, MIN(art_start_date) art_start_date FROM ( "
            + " SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p "
            + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + " INNER JOIN obs o ON e.encounter_id = o.encounter_id "
            + " WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND e.encounter_type = 53 "
            + " AND o.concept_id = 1190 AND o.value_datetime is NOT NULL AND o.value_datetime <= :endInclusionDate AND e.location_id = :location "
            + " GROUP BY p.patient_id "
            + " ) art_start "
            + " GROUP BY patient_id "
            + " ) tx_new "
            + " INNER JOIN "
            + " ( "
            + "	Select 	p.patient_id,obsART.value_datetime data_lactante "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join person pe ON pe.person_id = e.patient_id and pe.gender = 'F' "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "					inner join obs obsART on e.encounter_id=obsART.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=6332 and o.value_coded=1065 and "
            + "					e.encounter_type=53 and e.location_id=:location and "
            + "					obsART.concept_id=1190 and obsART.voided=0 "
            + "					and e.encounter_datetime between :startInclusionDate and :endInclusionDate "
            + " ) lactante ON lactante.patient_id = tx_new.patient_id "
            + " WHERE lactante.data_lactante <= tx_new.art_start_date  and tx_new.art_start_date between :startInclusionDate and :endInclusionDate ";

    public static final String findPatientsWhoArePregnatInLastClinicalConsultationVLFR9 =
        " select ultima_consulta.patient_id from ( "
            + " Select p.patient_id, max(e.encounter_datetime) as data_ultima_consulta from "
            + " patient p "
            + " inner join encounter e on p.patient_id = e.patient_id "
            + " where p.voided = 0 and e.voided = 0 and e.encounter_type = 6 and e.location_id = :location "
            + " and e.encounter_datetime BETWEEN :startInclusionDate AND :endInclusiondate "
            + " group by p.patient_id "
            + " ) ultima_consulta "
            + " inner join encounter e_ on e_.patient_id = ultima_consulta.patient_id "
            + " inner join obs obsGravida on e_.encounter_id = obsGravida.encounter_id "
            + " inner join person pe on pe.person_id = e_.patient_id "
            + " where pe.voided = 0 and e_.voided = 0 and obsGravida.voided = 0 and e_.encounter_type = 6 and e_.location_id = :location "
            + " and obsGravida.concept_id = 1982 and obsGravida.value_coded = 1065 and pe.gender = 'F' "
            + " and e_.encounter_datetime = ultima_consulta.data_ultima_consulta ";

    public static final String findPatientsWhoAreBreastfeedingInLastClinicalConsultationVLFR10 =
        " select ultima_consulta.patient_id from ( "
            + " Select p.patient_id, max(e.encounter_datetime) as data_ultima_consulta from "
            + " patient p "
            + " inner join encounter e on p.patient_id = e.patient_id "
            + " where p.voided = 0 and e.voided = 0 and e.encounter_type = 6 and e.location_id = :location "
            + " and e.encounter_datetime BETWEEN :startInclusionDate AND :endInclusionDate "
            + " group by p.patient_id "
            + " ) ultima_consulta "
            + " inner join encounter e_ on e_.patient_id = ultima_consulta.patient_id "
            + " inner join obs obsGravida on e_.encounter_id = obsGravida.encounter_id "
            + " inner join person pe on pe.person_id = e_.patient_id "
            + " where pe.voided = 0 and e_.voided = 0 and obsGravida.voided = 0 and e_.encounter_type = 6 and e_.location_id = :location "
            + " and obsGravida.concept_id = 6332 and obsGravida.value_coded = 1065 and pe.gender = 'F' "
            + " and e_.encounter_datetime = ultima_consulta.data_ultima_consulta ";

    public static final String
        findPatientsInFirstLineARTWithFirstVLAbove1000ExceptPregnantOrBreastfeedingInTheSameConsultationDuringEvaluationPeriod =
            "select cargaViral.patient_id from ( "
                + "select fvl.patient_id, fvl.data_carga from ( "
                + " select patient_id, min(data_carga) data_carga, encounter_id from ( "
                + " Select p.patient_id, e.encounter_datetime data_carga,  e.encounter_id  from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + " union "
                + " Select p.patient_id, o.obs_datetime data_carga, e.encounter_id from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + " o.obs_datetime between :startInclusionDate and :endInclusionDate   and e.location_id = :location and o.value_numeric >= 1000 "
                + ") first_vl group by patient_id "
                + ") fvl left join "
                + "( "
                + "Select p.patient_id, e.encounter_id from person pe "
                + "inner join patient p on pe.person_id=p.patient_id "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
                + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsLactante.voided=0 and e.encounter_type in (53, 6) and e.location_id=:location and "
                + "obsLactante.concept_id=6332 and obsLactante.value_coded=1065 and pe.gender='F' "
                + ") lactante on lactante.patient_id = fvl.patient_id and lactante.encounter_id = fvl.encounter_id "
                + "left join "
                + "( "
                + "Select p.patient_id, e.encounter_id from person pe "
                + "inner join patient p on pe.person_id=p.patient_id "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
                + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type in (53, 6) and e.location_id=:location and "
                + "obsGravida.concept_id=1982 and obsGravida.value_coded=1065 and pe.gender='F' "
                + ") gravida on gravida.patient_id = fvl.patient_id and gravida.encounter_id = fvl.encounter_id "
                + "where lactante.patient_id is null and gravida.patient_id is null "
                + ")cargaViral "
                + "inner join encounter  e on e.patient_id=cargaViral.patient_id "
                + "inner join obs obsLinha on obsLinha.encounter_id=e.encounter_id "
                + "where obsLinha.concept_id=21151 and e.encounter_type=6 and obsLinha.value_coded=21150 "
                + "and obsLinha.voided=0 and e.voided=0 and e.encounter_datetime between  :startInclusionDate and :endInclusionDate and e.location_id=:location "
                + "group by cargaViral.patient_id ";

    public static final String
        findPatientsWithCVAbove1000CopiesWhoHad3ConsecutiveMonthlyAPSSConsultations =
            "select carga_viral.patient_id from ( "
                + " select patient_id, min(data_carga) data_carga from ( "
                + " Select p.patient_id, e.encounter_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + " union "
                + " Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + " o.obs_datetime between :startInclusionDate and :endInclusionDate   and e.location_id = :location and o.value_numeric >= 1000 "
                + ") first_vl group by patient_id "
                + ") carga_viral "
                + "inner join encounter primeira_consulta on carga_viral.patient_id = primeira_consulta.patient_id and primeira_consulta.voided = 0 and primeira_consulta.encounter_type = 35 and "
                + "primeira_consulta.encounter_datetime=carga_viral.data_carga "
                + "inner join encounter segunda_consulta on carga_viral.patient_id = segunda_consulta.patient_id and segunda_consulta.voided = 0 and segunda_consulta.encounter_type = 35 "
                + "and (TIMESTAMPDIFF(DAY, carga_viral.data_carga, segunda_consulta.encounter_datetime)) between 20 and 33 "
                + "inner join encounter terceira_consulta on carga_viral.patient_id = terceira_consulta.patient_id and terceira_consulta.voided = 0 and terceira_consulta.encounter_type = 35 "
                + "and (TIMESTAMPDIFF(DAY, segunda_consulta.encounter_datetime, terceira_consulta.encounter_datetime)) between 20 and 33 ";

    public static final String
        findPatientsWhoHaveVLLaboratoryRequestOnClinicalConsultationBetween80And130OfFirstVLDate =
            " Select carga_viral.patient_id "
                + " from "
                + " ( "
                + " select patient_id, min(data_carga) data_carga from ( "
                + " Select p.patient_id, e.encounter_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + " union "
                + " Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + " o.obs_datetime between :startInclusionDate and :endInclusionDate   and e.location_id = :location and o.value_numeric >= 1000 "
                + ") first_vl group by patient_id "
                + " ) carga_viral "
                + " inner join encounter e ON e.patient_id = carga_viral.patient_id and e.voided = 0 and e.location_id = :location and e.encounter_type = 6 "
                + " inner join obs o ON o.encounter_id = e.encounter_id and o.voided = 0 and o.concept_id = 23722 and o.value_coded = 856 "
                + " and e.encounter_datetime BETWEEN date_add(carga_viral.data_carga, INTERVAL 80 DAY) AND date_add(carga_viral.data_carga, INTERVAL 130 DAY) ";

    public static final String
        findPatientsWhoHadRecordOfSecondViralLoadResultAbove1000InClinicalConsultationBetween110And160DaysOfFirstVL =
            " Select primeira_carga.patient_id "
                + " from "
                + " (select patient_id, min(data_carga) data_carga from ( "
                + " Select p.patient_id, e.encounter_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + " union "
                + " Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + " o.obs_datetime between :startInclusionDate and :endInclusionDate   and e.location_id = :location and o.value_numeric >= 1000 "
                + ") first_vl group by patient_id "
                + ") primeira_carga "
                + " inner join encounter e ON e.patient_id = primeira_carga.patient_id and e.voided = 0 and e.location_id = :location and e.encounter_type = 6 "
                + " inner join obs o ON o.encounter_id = e.encounter_id and o.voided = 0 and o.concept_id = 856 and o.value_numeric >= 1000 "
                + " and e.encounter_datetime BETWEEN date_add(primeira_carga.data_carga, INTERVAL 110 DAY) AND date_add(primeira_carga.data_carga, INTERVAL 160 DAY) ";

    public static final String
        findPatientsWhithRecordOfLastViralLoadResultAbove1000InFichaResumoBetween110And160DaysOfFirstVL =
            " select patient_id from ( "
                + " Select primeira_carga.patient_id, max(segunda_carga.data_carga) data_carga "
                + " from "
                + " ( "
                + " select patient_id, min(data_carga) data_carga from ( "
                + " Select p.patient_id, e.encounter_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + " union "
                + " Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + " o.obs_datetime between :startInclusionDate and :endInclusionDate   and e.location_id = :location and o.value_numeric >= 1000 "
                + ") first_vl group by patient_id "
                + " ) primeira_carga "
                + "inner join ( "
                + "Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + "e.location_id = :location and o.value_numeric >= 1000 "
                + ") segunda_carga on primeira_carga.patient_id = segunda_carga.patient_id and segunda_carga.data_carga "
                + " BETWEEN date_add(primeira_carga.data_carga, INTERVAL 110 DAY) AND date_add(primeira_carga.data_carga, INTERVAL 160 DAY) "
                + " group by segunda_carga.patient_id "
                + " ) final ";

    public static final String
        findPatientsWithSecondVLQtQlBelow1000InClinicalConsultationRegisteredBetween110And160OfFirstVL =
            " Select primeira_carga.patient_id "
                + " from "
                + " (select patient_id, min(data_carga) data_carga from ( "
                + " Select p.patient_id, e.encounter_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + " union "
                + " Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + " o.obs_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + ") first_vl group by patient_id "
                + ") primeira_carga "
                + " inner join encounter e ON e.patient_id = primeira_carga.patient_id and e.voided = 0 and e.location_id = :location and e.encounter_type = 6 "
                + " inner join obs o ON o.encounter_id = e.encounter_id and o.voided = 0 and ((o.concept_id = 856 and o.value_numeric < 1000) OR (o.concept_id = 1305 and o.value_coded is not null)) "
                + " and e.encounter_datetime BETWEEN date_add(primeira_carga.data_carga, INTERVAL 110 DAY) AND date_add(primeira_carga.data_carga, INTERVAL 160 DAY) ";

    public static final String
        findPatientsWithLastVLBelow1000InFichaResumoRegisteredBetween110And160DaysOfFirstVL =
            "select patient_id from ( "
                + " Select primeira_carga.patient_id, max(segunda_carga.data_carga) data_carga "
                + " from "
                + " ( "
                + "select patient_id, min(data_carga) data_carga from ( "
                + " Select p.patient_id, e.encounter_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + " union "
                + " Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + " o.obs_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + ") first_vl group by patient_id "
                + " ) primeira_carga "
                + "inner join ( "
                + "Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + "e.location_id = :location and o.value_numeric < 1000 "
                + ") segunda_carga on primeira_carga.patient_id = segunda_carga.patient_id and segunda_carga.data_carga "
                + " BETWEEN date_add(primeira_carga.data_carga, INTERVAL 110 DAY) AND date_add(primeira_carga.data_carga, INTERVAL 160 DAY) "
                + " group by segunda_carga.patient_id "
                + " ) final ";

    public static final String findPatientsInFirstLineARTInTheEvaluationPeriod =
        "Select p.patient_id from patient p "
            + " inner join encounter e on p.patient_id = e.patient_id "
            + " inner join obs o on e.encounter_id=o.encounter_id "
            + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 21151 and o.value_coded = 21150 and "
            + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location ";

    public static final String
        findPatientsMarkedWithSecondLineFieldOnFichaFichaResumoWithTheMostRecentDate =
            " select segunda_linha.patient_id from ( "
                + " SELECT patient_id, MAX(data_carga) data_carga FROM ( "
                + " "
                + " Select primeira_carga.patient_id ,e.encounter_datetime data_carga "
                + " from "
                + " ( "
                + " select patient_id, min(data_carga) data_carga from ( "
                + " Select p.patient_id, e.encounter_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + " union "
                + " Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + " o.obs_datetime between :startInclusionDate and :endInclusionDate   and e.location_id = :location and o.value_numeric >= 1000 "
                + ") first_vl group by patient_id "
                + ") primeira_carga "
                + " inner join encounter e ON e.patient_id = primeira_carga.patient_id and e.voided = 0 and e.location_id = :location and e.encounter_type = 6 "
                + " inner join obs o ON o.encounter_id = e.encounter_id and o.voided = 0 and o.concept_id = 856 and o.value_numeric >= 1000 "
                + " and e.encounter_datetime BETWEEN date_add(primeira_carga.data_carga, INTERVAL 110 DAY) AND date_add(primeira_carga.data_carga, INTERVAL 160 DAY) "
                + " "
                + "UNION "
                + " "
                + " select patient_id,data_carga  from ( "
                + " Select primeira_carga.patient_id, max(segunda_carga.data_carga) data_carga "
                + " from "
                + " ( "
                + " select patient_id, min(data_carga) data_carga from ( "
                + " Select p.patient_id, e.encounter_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + " union "
                + " Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + " o.obs_datetime between :startInclusionDate and :endInclusionDate   and e.location_id = :location and o.value_numeric >= 1000 "
                + ") first_vl group by patient_id "
                + " ) primeira_carga "
                + "inner join ( "
                + "Select p.patient_id, o.obs_datetime data_carga from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + "e.location_id = :location and o.value_numeric >= 1000 "
                + ") segunda_carga on primeira_carga.patient_id = segunda_carga.patient_id and segunda_carga.data_carga "
                + " BETWEEN date_add(primeira_carga.data_carga, INTERVAL 110 DAY) AND date_add(primeira_carga.data_carga, INTERVAL 160 DAY) "
                + " group by segunda_carga.patient_id "
                + " ) final "
                + " "
                + ") final_second group by patient_id "
                + " "
                + ") final_second "
                + " "
                + "inner join ( "
                + " "
                + " select p.patient_id, max(o.obs_datetime) data_linha "
                + " from patient p "
                + " join encounter e on p.patient_id = e.patient_id "
                + " join obs o on o.encounter_id = e.encounter_id "
                + " where e.encounter_type = 53 and e.voided = 0 and p.voided = 0 and o.voided = 0 and o.value_coded is not null "
                + " and o.concept_id = 21187 "
                + " and o.obs_datetime between :startInclusionDate and :endInclusionDate and e.location_id = :location "
                + " group by p.patient_id "
                + " ) segunda_linha on segunda_linha.patient_id = final_second.patient_id "
                + " and segunda_linha.data_linha between final_second.data_carga and :endRevisionDate ";

    public static final String
        findPatientsWithViralLoadResultInFichaClinicaFichaResumoPregnantNotBreastFeeding =
            " select vlPregnant.patient_id from( "
                + " "
                + " select finalVL.patient_id, data_carga, finalVL.encounter_id from ( "
                + " select patient_id, min(data_carga) data_carga, encounter_id from ( "
                + " Select p.patient_id, e.encounter_datetime data_carga,  e.encounter_id  from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id = :location and o.value_numeric >= 1000 "
                + " union "
                + " Select p.patient_id, o.obs_datetime data_carga, e.encounter_id from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 53 and  o.concept_id = 856 and "
                + " o.obs_datetime between :startInclusionDate and :endInclusionDate   and e.location_id = :location and o.value_numeric >= 1000 "
                + ") first_vl group by patient_id "
                + ") finalVL "
                + "inner join person pe on pe.person_id=finalVL.patient_id "
                + "inner join obs obsGravida on finalVL.encounter_id=obsGravida.encounter_id "
                + "where pe.voided=0 and obsGravida.voided=0 and obsGravida.location_id = :location and "
                + "obsGravida.concept_id=1982 and obsGravida.value_coded=1065 and pe.gender='F' "
                + ") vlPregnant left join "
                + "( "
                + "Select p.patient_id, e.encounter_id from person pe "
                + "inner join patient p on pe.person_id=p.patient_id "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
                + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsLactante.voided=0 and e.encounter_type in (53, 6) and e.location_id=:location and "
                + "obsLactante.concept_id=6332 and obsLactante.value_coded=1065 and pe.gender='F' "
                + ") lactante on lactante.patient_id = vlPregnant.patient_id and lactante.encounter_id = vlPregnant.encounter_id "
                + "where lactante.patient_id is null ";
  }
}
