package org.openmrs.module.eptsreports.reporting.library.queries.data.quality.duplicate;

public interface EC1DuplicateQueries {
  class QUERY {

    public static String findPatiendsWithDuplicatedNID =
        "    						select distinct patient.patient_id, "
            + "                           	l.name locationName, "
            + "                           	patient_identifier.patient_identifier_id, "
            + "                           	patient_identifier.identifier, "
            + "                            		concat(ifnull(person_name.given_name,''),' ',ifnull(person_name.middle_name,''),' ',ifnull(person_name.family_name,'')) as nomeCompleto, "
            + "                            		DATE_FORMAT(date(person.birthdate), '%d/%m/%Y') as birthdate, "
            + "                            		if(person.birthdate_estimated = true, 'Sim','Não') birthdate_estimated, "
            + "                            		person.gender, "
            + "                            		DATE_FORMAT(date(patient.date_created), '%d/%m/%Y') as date_created, "
            + "                            		DATE_FORMAT(date(patient.date_changed), '%d/%m/%Y') as date_changed, "
            + "                            		DATE_FORMAT(date(patient_identifier.date_created), '%d/%m/%Y') as dataCriacaoNID, "
            + "                            		if(patient_identifier.preferred = true, 'Sim','Não') nidPreferido, "
            + "                            		 DATE_FORMAT(programState.date_enrolled, '%d/%m/%Y') AS date_enrolled, "
            + "						 case "
            + "						 when programState.state = 9 then 'DROPPED FROM TREATMENT' "
            + "						 when programState.state = 6 then 'ACTIVE ON PROGRAM' "
            + "						 when programState.state = 10 then 'PATIENT HAS DIED' "
            + "						 when programState.state = 8 then 'SUSPENDED TREATMENT' "
            + "						 when programState.state = 7 then 'TRANSFERED OUT TO ANOTHER FACILITY' "
            + "						 when programState.state = 29 then 'TRANSFERRED FROM OTHER FACILTY' "
            + "						 end AS state, "
            + "						 DATE_FORMAT(programState.start_date, '%d/%m/%Y') AS state_date, "
            + "						 DATE_FORMAT(tx_new.art_start_date, '%d/%m/%Y') AS art_start_date, "
            + "						 if(transferred_in.patient_id is null, 'Não','Sim') transferred_in, "
            + "						 DATE_FORMAT(levantamento.encounter_datetime, '%d/%m/%Y') AS data_fila_recepcao, "
            + "						 DATE_FORMAT(date(fichaClinica.encounter_datetime), '%d/%m/%Y') as ultima_ficha_clinica, "
            + "						 if(gravidaLactante.patient_id is null, null, if(gravidaLactante.decisao = 2, 'Grávida','Lactante')) gravidez_lactante, "
            + "						 if(tratamento.tratamento_tb is null, 'Não','Sim') tratamento_tb, "
            + "						 tratamento.book_number numero_livro, "
            + "						 tratamento.page_number pagina_numero, "
            + "						 tratamento.line_number linha_numero "
            + "                           from "
            + "                           ( "
            + "             				   select distinct patient.patient_id, patient_identifier.identifier from( "
            + "             select identifier  from patient_identifier pi "
            + "             	join patient on patient.patient_id = pi.patient_id "
            + "             where pi.voided = 0 and  pi.identifier_type =2 "
            + "             and patient.voided =0 "
            + "             group by pi.identifier  having count(*) >= 2 "
            + "             ) NID "
            + "             inner join patient_identifier on patient_identifier.identifier = NID.identifier "
            + "             inner join patient on patient.patient_id =patient_identifier.patient_id "
            + "             where patient.voided =0 and patient_identifier.voided =0  order by patient_identifier.identifier "
            + "             		     ) patientNID "
            + "                            inner join patient_identifier on patient_identifier.identifier = patientNID.identifier and patient_identifier.preferred = true "
            + "                            inner join patient on patient.patient_id =patient_identifier.patient_id "
            + "                            inner join person  on person.person_id =patient.patient_id "
            + "                            inner join person_name on person_name.person_id = patient.patient_id "
            + "                            left join location l on (l.location_id =patient_identifier.location_id and l.retired =0) "
            + "                            left join patient_program on (patient_program.patient_id = patient.patient_id and patient_program.program_id=2 and patient_program.voided =0) "
            + "					 LEFT JOIN (SELECT pg.patient_id, pg.date_enrolled, ps.state, max(ps.start_date) AS start_date "
            + "					 FROM patient_program pg "
            + "					 INNER JOIN patient_state ps ON pg.patient_program_id = ps.patient_program_id "
            + "					 AND ps.start_date IS NOT NULL "
            + "					 AND ps.end_date IS NULL "
            + "					 AND pg.program_id = 2 "
            + "					 GROUP BY pg.patient_id "
            + "					 ) AS programState  ON patient.patient_id = programState.patient_id "
            + "					 left join "
            + "					 (SELECT patient_id, MIN(art_start_date) art_start_date FROM "
            + "					(SELECT p.patient_id, MIN(e.encounter_datetime) art_start_date FROM patient p "
            + "					INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "					INNER JOIN obs o ON o.encounter_id=e.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "					WHERE e.voided=0 AND o.voided=0 AND p.voided=0 AND e.encounter_type in (18,6,9) "
            + "					AND o.concept_id=1255 AND o.value_coded=1256 AND e.encounter_datetime<=curdate() "
            + "					GROUP BY p.patient_id "
            + "					UNION "
            + "					SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "					INNER JOIN obs o ON e.encounter_id=o.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "					WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND e.encounter_type IN (18,6,9,53) "
            + "					AND o.concept_id=1190 AND o.value_datetime is NOT NULL AND o.value_datetime<=curdate() "
            + "					GROUP BY p.patient_id "
            + "					UNION "
            + "					SELECT pg.patient_id, MIN(date_enrolled) art_start_date FROM patient p "
            + "					INNER JOIN patient_program pg ON p.patient_id=pg.patient_id "
            + "					inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "					WHERE pg.voided=0 AND p.voided=0 AND program_id=2 AND date_enrolled<=curdate() "
            + "					GROUP BY pg.patient_id "
            + "					UNION "
            + "					SELECT e.patient_id, MIN(e.encounter_datetime) AS art_start_date FROM patient p "
            + "					INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "					WHERE p.voided=0 AND e.encounter_type=18 AND e.voided=0 "
            + "					AND e.encounter_datetime<=curdate() "
            + "					GROUP BY p.patient_id "
            + "					UNION "
            + "					SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p "
            + "					INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "					INNER JOIN obs o ON e.encounter_id=o.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "					WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND e.encounter_type=52 "
            + "					AND o.concept_id=23866 AND o.value_datetime is NOT NULL AND o.value_datetime<=curdate() "
            + "					GROUP BY p.patient_id "
            + "					) "
            + "					art_start GROUP BY patient_id "
            + "					) tx_new on tx_new.patient_id = patient.patient_id "
            + "					left join "
            + "			      ( "
            + "			       select state_transferred_in.patient_id,art_start_date from "
            + "			       ( "
            + "			           select p.patient_id, pg.patient_program_id, ps.start_date as art_start_date  from patient p "
            + "			               inner join patient_program pg on p.patient_id=pg.patient_id "
            + "			                 inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "			                 inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "			           where pg.voided=0 and ps.voided=0 and p.voided=0 and pg.program_id=2 "
            + "			           and ps.start_date <= curdate() "
            + "			           group by pg.patient_program_id "
            + "			       ) state_transferred_in "
            + "			         inner join patient_state ps on ps.patient_program_id=state_transferred_in.patient_program_id "
            + "			       where ps.start_date=state_transferred_in.art_start_date and ps.state=29 and ps.voided=0 "
            + "			       union "
            + "			     select state_transferred_in.patient_id, art_start_date from "
            + "			       ( "
            + "			           select p.patient_id, obsdata.value_datetime art_start_date from patient p "
            + "			             inner join encounter e on p.patient_id=e.patient_id "
            + "			             inner join obs obstrans on e.encounter_id=obstrans.encounter_id and obstrans.voided=0 and obstrans.concept_id=1369 and obstrans.value_coded=1065 "
            + "			             inner join obs obstarv on e.encounter_id=obstarv.encounter_id and obstarv.voided=0 and obstarv.concept_id=6300 and obstarv.value_coded=6276 "
            + "			             inner join obs obsdata on e.encounter_id=obsdata.encounter_id and obsdata.voided=0 and obsdata.concept_id=23891 "
            + "			             inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			         where p.voided=0 and e.voided=0 and e.encounter_type=53 and obsdata.value_datetime <= curdate() "
            + "			         group by p.patient_id "
            + "			         ) state_transferred_in group by state_transferred_in.patient_id "
            + "			         ) transferred_in on transferred_in.patient_id = patient.patient_id "
            + "			         left join "
            + "			         ( "
            + "				select patient_id, max(encounter_datetime) encounter_datetime from ( "
            + "				Select p.patient_id, max(e.encounter_datetime) encounter_datetime from  patient p "
            + "				inner join encounter e on p.patient_id = e.patient_id "
            + "				inner join location l on l.location_id = e.location_id "
            + "				where  p.voided = 0 and e.voided = 0 and e.encounter_datetime <= curdate() and e.encounter_type = 18 "
            + "				group by p.patient_id "
            + "				union "
            + "				SELECT  p.patient_id, max(o.value_datetime) encounter_datetime FROM  patient p "
            + "				INNER JOIN encounter e on p.patient_id = e.patient_id "
            + "				inner join obs o on e.encounter_id = o.encounter_id "
            + "				inner join location l on l.location_id = e.location_id "
            + "				where  p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 52 "
            + "				AND o.concept_id = 23866 and o.value_datetime is not null and o.value_datetime <= curdate() "
            + "				group by p.patient_id "
            + "				) levantamento group by patient_id "
            + "			         ) levantamento on levantamento.patient_id = patient.patient_id "
            + "			  left join( "
            + "			Select p.patient_id, max(e.encounter_datetime) encounter_datetime from  patient p "
            + "			inner join encounter e on p.patient_id = e.patient_id "
            + "			inner join location l on l.location_id = e.location_id "
            + "			where  p.voided = 0 and e.voided = 0 and e.encounter_datetime <= curdate() and e.encounter_type = 6 "
            + "			group by p.patient_id "
            + "			) fichaClinica  on fichaClinica.patient_id = patient.patient_id "
            + "			left join ( "
            + "			select patient_id,decisao from ( "
            + "			select inicio_real.patient_id,gravida_real.data_gravida, lactante_real.data_parto, "
            + "			if(max(gravida_real.data_gravida) is null and max(lactante_real.data_parto) is null,null, "
            + "			if(max(gravida_real.data_gravida) is null,1, "
            + "			if(max(lactante_real.data_parto) is null,2, "
            + "			if(max(lactante_real.data_parto)=max(gravida_real.data_gravida),2, "
            + "			if(max(lactante_real.data_parto)>max(gravida_real.data_gravida),1,2 "
            + "			))))) decisao from ( "
            + "			select p.patient_id "
            + "			from patient p "
            + "			inner join encounter e on e.patient_id=p.patient_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where e.voided=0 and p.voided=0 and e.encounter_type in (5,7) and e.encounter_datetime "
            + "			between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			select pg.patient_id from patient p "
            + "			inner join patient_program pg on p.patient_id=pg.patient_id "
            + "			inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "			where pg.voided=0 and p.voided=0 and program_id in (1,2) and "
            + "			date_enrolled between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=53 and o.concept_id=23891 "
            + "			and o.value_datetime is not null "
            + "			and o.value_datetime between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() )inicio_real "
            + "			left join ( "
            + "			Select p.patient_id,e.encounter_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1982 "
            + "			and value_coded=1065 and e.encounter_type in (5,6) "
            + "			and e.encounter_datetime  between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id,e.encounter_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1279 "
            + "			and e.encounter_type in (5,6) "
            + "			and e.encounter_datetime between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			Select "
            + "			p.patient_id,e.encounter_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and concept_id=1600 and e.encounter_type in (5,6) "
            + "			and e.encounter_datetime between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id,e.encounter_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and concept_id=6334 and value_coded=6331 and e.encounter_type in (5,6) "
            + "			and e.encounter_datetime  between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			select pp.patient_id,pp.date_enrolled data_gravida from patient_program pp "
            + "			inner join location on (location.location_id = pp.location_id and location.retired =0) "
            + "			where pp.program_id=8 and pp.voided=0 "
            + "			and pp.date_enrolled between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id,obsART.value_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join obs obsART on e.encounter_id=obsART.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and o.concept_id=1982 and o.value_coded=1065 and "
            + "			e.encounter_type=53 "
            + "			and obsART.value_datetime between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			and obsART.concept_id=1190 and obsART.voided=0 "
            + "			union "
            + "			Select p.patient_id,o.value_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and o.concept_id=1465 and e.encounter_type=6 "
            + "			and o.value_datetime between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			) gravida_real on gravida_real.patient_id=inicio_real.patient_id "
            + "			left join ( "
            + "			Select p.patient_id,o.value_datetime data_parto from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=5599 and "
            + "			e.encounter_type in (5,6) "
            + "			and o.value_datetime between date_sub(curdate(), INTERVAL 18 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id, e.encounter_datetime data_parto from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and concept_id=6332 and value_coded=1065 and e.encounter_type=6 "
            + "			and e.encounter_datetime between date_sub(curdate(), INTERVAL 18 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id, obsART.value_datetime data_parto from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join obs obsART on e.encounter_id=obsART.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and o.concept_id=6332 and o.value_coded=1065 and e.encounter_type=53 and "
            + "			obsART.value_datetime between date_sub(curdate(), INTERVAL 18 MONTH) and curdate() "
            + "			and obsART.concept_id=1190 and obsART.voided=0 "
            + "			union "
            + "			Select p.patient_id, e.encounter_datetime data_parto from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6334 and value_coded=6332 and "
            + "			e.encounter_type in (5,6) "
            + "			and e.encounter_datetime between date_sub(curdate(), INTERVAL 18 MONTH) and curdate() "
            + "			union "
            + "			select pg.patient_id,ps.start_date data_parto from patient p "
            + "			inner join patient_program pg on p.patient_id=pg.patient_id "
            + "			inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "			inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "			where pg.voided=0 and ps.voided=0 and p.voided=0 "
            + "			and pg.program_id=8 and ps.state=27 and ps.end_date is null "
            + "			and ps.start_date between date_sub(curdate(), INTERVAL 18 MONTH) and curdate() "
            + "			) lactante_real on lactante_real.patient_id=inicio_real.patient_id "
            + "			where lactante_real.data_parto is not null or gravida_real.data_gravida is not null "
            + "			group by inicio_real.patient_id "
            + "			) gravidaLactante "
            + "			inner join person pe on pe.person_id=gravidaLactante.patient_id "
            + "			and pe.voided=0 and pe.gender='F' "
            + "			) gravidaLactante on gravidaLactante.patient_id = patient.patient_id "
            + "			inner join "
            + "			( "
            + "			    						select patient_id "
            + "	from "
            + "	(select   	inicio_fila_seg_prox.*, "
            + "			GREATEST(COALESCE(data_fila,data_seguimento,data_recepcao_levantou),COALESCE(data_seguimento,data_fila,data_recepcao_levantou),COALESCE(data_recepcao_levantou,data_seguimento,data_fila))  data_usar_c, "
            + "		    GREATEST(COALESCE(data_proximo_lev,data_proximo_seguimento,data_recepcao_levantou30),COALESCE(data_proximo_seguimento,data_proximo_lev,data_recepcao_levantou30),COALESCE(data_recepcao_levantou30,data_proximo_seguimento,data_proximo_lev)) data_usar "
            + "	from "
            + "		(select 	inicio_fila_seg.*, "
            + "		max(obs_fila.value_datetime) data_proximo_lev, "
            + "		max(obs_seguimento.value_datetime) data_proximo_seguimento, "
            + "		date_add(data_recepcao_levantou, interval 30 day) data_recepcao_levantou30 "
            + "  from "
            + "(select inicio.*, "
            + "		saida.data_estado, "
            + "		max_fila.data_fila, "
            + "		max_consulta.data_seguimento, "
            + "		max_recepcao.data_recepcao_levantou "
            + " from "
            + " (	Select patient_id,min(data_inicio) data_inicio "
            + "		from "
            + "			( "
            + "				Select 	p.patient_id,min(e.encounter_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on o.encounter_id=e.encounter_id "
            + "						inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "				where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "						e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and "
            + "						e.encounter_datetime<=curdate() "
            + "				group by p.patient_id "
            + "				union "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "						inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and "
            + "						o.concept_id=1190 and o.value_datetime is not null and "
            + "						o.value_datetime<=curdate() "
            + "				group by p.patient_id "
            + "				union "
            + "				select 	pg.patient_id,min(date_enrolled) data_inicio "
            + "				from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id "
            + "				inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "				where 	pg.voided=0 and p.voided=0 and program_id=2 "
            + "				and date_enrolled<=curdate() "
            + "				group by pg.patient_id "
            + "				union "
            + "				  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio "
            + "				  FROM 		patient p "
            + "							inner join encounter e on p.patient_id=e.patient_id "
            + "							inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "				  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 "
            + "				  and e.encounter_datetime<=curdate() "
            + "				  GROUP BY 	p.patient_id "
            + "				union "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "						inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "						o.concept_id=23866 and o.value_datetime is not null and "
            + "						o.value_datetime<=curdate() "
            + "				group by p.patient_id "
            + "			) inicio_real "
            + "		group by patient_id "
            + "  )inicio "
            + "  left join "
            + "	( "
            + "	select patient_id,max(data_estado) data_estado "
            + "	from "
            + "		( "
            + "			select distinct max_estado.patient_id, max_estado.data_estado from ( "
            + "				select	pg.patient_id, "
            + "						max(ps.start_date) data_estado "
            + "				from	patient p "
            + "					inner join patient_program pg on p.patient_id = pg.patient_id "
            + "					inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
            + "					inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "				where pg.voided=0 and ps.voided=0 and p.voided=0 and pg.program_id = 2 "
            + "					and ps.start_date<= curdate() "
            + "					group by pg.patient_id "
            + "			) max_estado "
            + "				inner join patient_program pp on pp.patient_id = max_estado.patient_id "
            + "				inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
            + "				inner join location on (location.location_id = pp.location_id and location.retired =0) "
            + "			where pp.program_id = 2 and ps.state in (7,8,10) and pp.voided = 0 and ps.voided = 0 "
            + "			union "
            + "			select 	p.patient_id, "
            + "					max(o.obs_datetime) data_estado "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs  o on e.encounter_id=o.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "					e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and "
            + "					o.obs_datetime<=curdate() "
            + "			group by p.patient_id "
            + "			union "
            + "			select person_id as patient_id,death_date as data_estado "
            + "			from person "
            + "			where dead=1 and death_date is not null and death_date<=curdate() "
            + "			union "
            + "			select 	p.patient_id, "
            + "					max(obsObito.obs_datetime) data_estado "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs obsObito on e.encounter_id=obsObito.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and "
            + "					e.encounter_type in (21,36,37) and  e.encounter_datetime<=curdate() and "
            + "					obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366 "
            + "			group by p.patient_id "
            + "			union "
            + "			select 	p.patient_id,max(e.encounter_datetime) data_estado "
            + "			from	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on o.encounter_id=e.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where 	e.voided=0 and p.voided=0 and e.encounter_datetime<=curdate() and "
            + "					o.voided=0 and o.concept_id=2016 and o.value_coded in (1706,23863) and e.encounter_type in (21,36,37) "
            + "			group by p.patient_id "
            + "		) allSaida "
            + "	group by patient_id "
            + "  ) saida on inicio.patient_id=saida.patient_id "
            + " left join "
            + "  ( Select p.patient_id,max(encounter_datetime) data_fila "
            + "	from 	patient p "
            + "			inner join encounter e on e.patient_id=p.patient_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "	where 	p.voided=0 and e.voided=0 and e.encounter_type=18 and "
            + "			e.encounter_datetime<=curdate() "
            + "	group by p.patient_id "
            + " ) max_fila on inicio.patient_id=max_fila.patient_id "
            + "  left join "
            + "  (	Select 	p.patient_id,max(encounter_datetime) data_seguimento "
            + "	from 	patient p "
            + "			inner join encounter e on e.patient_id=p.patient_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "	where 	p.voided=0 and e.voided=0 and e.encounter_type in (6,9) and "
            + "			e.encounter_datetime<=curdate() "
            + "	group by p.patient_id "
            + " ) max_consulta on inicio.patient_id=max_consulta.patient_id "
            + "  left join "
            + "  ( "
            + "	Select 	p.patient_id,max(value_datetime) data_recepcao_levantou "
            + "	from 	patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "			o.concept_id=23866 and o.value_datetime is not null and "
            + "			o.value_datetime<=curdate() "
            + "	group by p.patient_id "
            + "  ) max_recepcao on inicio.patient_id=max_recepcao.patient_id "
            + "  group by inicio.patient_id "
            + " ) inicio_fila_seg "
            + "  left join "
            + "	 obs obs_fila on obs_fila.person_id=inicio_fila_seg.patient_id "
            + "	 inner join location lo on (lo.location_id = obs_fila.location_id and lo.retired =0) "
            + "   and obs_fila.voided=0 "
            + "	 and obs_fila.obs_datetime=inicio_fila_seg.data_fila "
            + "	 and obs_fila.concept_id=5096 "
            + "  left join "
            + "	obs obs_seguimento on obs_seguimento.person_id=inicio_fila_seg.patient_id "
            + "	and obs_seguimento.location_id = lo.location_id "
            + "	and obs_seguimento.voided=0 "
            + "	and obs_seguimento.obs_datetime=inicio_fila_seg.data_seguimento "
            + "	and obs_seguimento.concept_id=1410 "
            + " group by inicio_fila_seg.patient_id "
            + " ) inicio_fila_seg_prox "
            + " group by patient_id "
            + " ) coorte12meses_final "
            + " where (data_estado is null or (data_estado is not null and  data_usar_c>data_estado)) and date_add(data_usar, interval 28 day) >=curdate() "
            + "			) tx_curr on tx_curr.patient_id = patient.patient_id "
            + "			left join "
            + "			( "
            + "			select final.patient_id, "
            + "			  MAX(CASE WHEN final.source = 'T1' then final.patient_id END) as tratamento_tb, "
            + "	            MAX(CASE WHEN final.source = 'T2' then final.valor2 END) as book_number, "
            + "	            MAX(CASE WHEN final.source = 'T3' then final.valor2 END) as page_number, "
            + "	            MAX(CASE WHEN final.source = 'T4' then final.valor2 END) as line_number "
            + "	    FROM "
            + "	    ( "
            + "						select tratamentoTb.patient_id, tratamentoTb.data_tratamento as valor1,tratamentoTb.patient_id as valor2, 'T1' source from ( "
            + "			                             Select p.patient_id, o.value_datetime data_tratamento from  patient p "
            + "                              inner join encounter e on p.patient_id=e.patient_id "
            + "                              inner join obs o on e.encounter_id=o.encounter_id "
            + "                              inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "                              where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in(6,9) "
            + "                              and o.concept_id=1113 and o.value_datetime between date_sub(curdate(), interval 7 MONTH) and curdate() "
            + "                              union "
            + "                              select  pg.patient_id, pg.date_enrolled  data_tratamento "
            + "                                      from  patient p inner join patient_program pg on p.patient_id=pg.patient_id "
            + "                                      inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "                              where   pg.voided=0 and p.voided=0 and program_id=5 and pg.date_enrolled "
            + "                              between date_sub(curdate(), interval 7 MONTH) and curdate() "
            + "                              union "
            + "                              Select p.patient_id,o.obs_datetime data_tratamento from  patient p "
            + "                              inner join encounter e on p.patient_id=e.patient_id "
            + "                              inner join obs o on e.encounter_id=o.encounter_id "
            + "                              inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "                              where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=53 "
            + "                              and o.concept_id=1406 and o.value_coded=42 and o.obs_datetime "
            + "                              between date_sub(curdate(), interval 7 MONTH) and curdate() "
            + "                              union "
            + "                              Select p.patient_id,o.obs_datetime data_tratamento from  patient p "
            + "                              inner join encounter e on p.patient_id=e.patient_id "
            + "                              inner join obs o on e.encounter_id=o.encounter_id "
            + "                              inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "                              where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=6 "
            + "                              and o.concept_id=1268 and o.value_coded=1256 and o.obs_datetime "
            + "                              between date_sub(curdate(), interval 7 MONTH) and curdate() "
            + "                              union "
            + "                              Select p.patient_id,o.obs_datetime data_tratamento from  patient p "
            + "                              inner join encounter e on p.patient_id=e.patient_id "
            + "                              inner join obs o on e.encounter_id=o.encounter_id "
            + "                              inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "                              where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=6 "
            + "                              and o.concept_id=23761 and o.value_coded=1065 and o.obs_datetime "
            + "                              between date_sub(curdate(), interval 7 MONTH) and curdate() "
            + "                              ) tratamentoTb "
            + "                              union "
            + "                               Select  p.patient_id, max(e.encounter_datetime),o.value_numeric book_number, 'T2' source  from  patient p "
            + "                              inner join encounter e on p.patient_id=e.patient_id "
            + "                              inner join obs o on e.encounter_id=o.encounter_id "
            + "                              inner join obs page on e.encounter_id=page.encounter_id "
            + "                              inner join obs line on e.encounter_id=line.encounter_id "
            + "                              inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "                              where p.voided=0 and e.voided=0 and o.voided=0 and page.voided = 0 and line.voided = 0 and e.encounter_type=53 "
            + "                              and o.concept_id=23806 and page.concept_id = 6266 and line.concept_id = 6268 "
            + "                              group by p.patient_id "
            + "                              union "
            + "                              Select  p.patient_id, max(e.encounter_datetime),page.value_numeric page_number, 'T3' source  from  patient p "
            + "                              inner join encounter e on p.patient_id=e.patient_id "
            + "                              inner join obs o on e.encounter_id=o.encounter_id "
            + "                              inner join obs page on e.encounter_id=page.encounter_id "
            + "                              inner join obs line on e.encounter_id=line.encounter_id "
            + "                              inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "                              where p.voided=0 and e.voided=0 and o.voided=0 and page.voided = 0 and line.voided = 0 and e.encounter_type=53 "
            + "                              and o.concept_id=23806 and page.concept_id = 6266 and line.concept_id = 6268 "
            + "                              group by p.patient_id "
            + "                              union "
            + "                              Select  p.patient_id, max(e.encounter_datetime),line.value_numeric line_number, 'T4' source  from  patient p "
            + "                              inner join encounter e on p.patient_id=e.patient_id "
            + "                              inner join obs o on e.encounter_id=o.encounter_id "
            + "                              inner join obs page on e.encounter_id=page.encounter_id "
            + "                              inner join obs line on e.encounter_id=line.encounter_id "
            + "                              inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "                              where p.voided=0 and e.voided=0 and o.voided=0 and page.voided = 0 and line.voided = 0 and e.encounter_type=53 "
            + "                              and o.concept_id=23806 and page.concept_id = 6266 and line.concept_id = 6268 "
            + "                              group by p.patient_id "
            + "                              ) final group by final.patient_id "
            + "			) tratamento on tratamento.patient_id = patient.patient_id "
            + "                            where patient_identifier.voided = 0 "
            + "                            and patient.voided =0 "
            + "                            and person.voided = 0 "
            + "                           group by patient_identifier.patient_identifier_id order by patient_identifier.identifier, patient_identifier.date_created desc ";
    public static String getEc1Total =
        "    						select distinct patient.patient_id "
            + "                           from "
            + "                           ( "
            + "             				   select distinct patient.patient_id, patient_identifier.identifier from( "
            + "             select identifier  from patient_identifier pi "
            + "             	join patient on patient.patient_id = pi.patient_id "
            + "             where pi.voided = 0 and  pi.identifier_type =2 "
            + "             and patient.voided =0 "
            + "             group by pi.identifier  having count(*) >= 2 "
            + "             ) NID "
            + "             inner join patient_identifier on patient_identifier.identifier = NID.identifier "
            + "             inner join patient on patient.patient_id =patient_identifier.patient_id "
            + "             where patient.voided =0 and patient_identifier.voided =0  order by patient_identifier.identifier "
            + "             		     ) patientNID "
            + "                            inner join patient_identifier on patient_identifier.identifier = patientNID.identifier and patient_identifier.preferred = true "
            + "                            inner join patient on patient.patient_id =patient_identifier.patient_id "
            + "                            inner join person  on person.person_id =patient.patient_id "
            + "                            inner join person_name on person_name.person_id = patient.patient_id "
            + "                            left join location l on (l.location_id =patient_identifier.location_id and l.retired =0) "
            + "                            left join patient_program on (patient_program.patient_id = patient.patient_id and patient_program.program_id=2 and patient_program.voided =0) "
            + "					 LEFT JOIN (SELECT pg.patient_id, pg.date_enrolled, ps.state, max(ps.start_date) AS start_date "
            + "					 FROM patient_program pg "
            + "					 INNER JOIN patient_state ps ON pg.patient_program_id = ps.patient_program_id "
            + "					 AND ps.start_date IS NOT NULL "
            + "					 AND ps.end_date IS NULL "
            + "					 AND pg.program_id = 2 "
            + "					 GROUP BY pg.patient_id "
            + "					 ) AS programState  ON patient.patient_id = programState.patient_id "
            + "					 left join "
            + "					 (SELECT patient_id, MIN(art_start_date) art_start_date FROM "
            + "					(SELECT p.patient_id, MIN(e.encounter_datetime) art_start_date FROM patient p "
            + "					INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "					INNER JOIN obs o ON o.encounter_id=e.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "					WHERE e.voided=0 AND o.voided=0 AND p.voided=0 AND e.encounter_type in (18,6,9) "
            + "					AND o.concept_id=1255 AND o.value_coded=1256 AND e.encounter_datetime<=curdate() "
            + "					GROUP BY p.patient_id "
            + "					UNION "
            + "					SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "					INNER JOIN obs o ON e.encounter_id=o.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "					WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND e.encounter_type IN (18,6,9,53) "
            + "					AND o.concept_id=1190 AND o.value_datetime is NOT NULL AND o.value_datetime<=curdate() "
            + "					GROUP BY p.patient_id "
            + "					UNION "
            + "					SELECT pg.patient_id, MIN(date_enrolled) art_start_date FROM patient p "
            + "					INNER JOIN patient_program pg ON p.patient_id=pg.patient_id "
            + "					inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "					WHERE pg.voided=0 AND p.voided=0 AND program_id=2 AND date_enrolled<=curdate() "
            + "					GROUP BY pg.patient_id "
            + "					UNION "
            + "					SELECT e.patient_id, MIN(e.encounter_datetime) AS art_start_date FROM patient p "
            + "					INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "					WHERE p.voided=0 AND e.encounter_type=18 AND e.voided=0 "
            + "					AND e.encounter_datetime<=curdate() "
            + "					GROUP BY p.patient_id "
            + "					UNION "
            + "					SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p "
            + "					INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "					INNER JOIN obs o ON e.encounter_id=o.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "					WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND e.encounter_type=52 "
            + "					AND o.concept_id=23866 AND o.value_datetime is NOT NULL AND o.value_datetime<=curdate() "
            + "					GROUP BY p.patient_id "
            + "					) "
            + "					art_start GROUP BY patient_id "
            + "					) tx_new on tx_new.patient_id = patient.patient_id "
            + "					left join "
            + "			      ( "
            + "			       select state_transferred_in.patient_id,art_start_date from "
            + "			       ( "
            + "			           select p.patient_id, pg.patient_program_id, ps.start_date as art_start_date  from patient p "
            + "			               inner join patient_program pg on p.patient_id=pg.patient_id "
            + "			                 inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "			                 inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "			           where pg.voided=0 and ps.voided=0 and p.voided=0 and pg.program_id=2 "
            + "			           and ps.start_date <= curdate() "
            + "			           group by pg.patient_program_id "
            + "			       ) state_transferred_in "
            + "			         inner join patient_state ps on ps.patient_program_id=state_transferred_in.patient_program_id "
            + "			       where ps.start_date=state_transferred_in.art_start_date and ps.state=29 and ps.voided=0 "
            + "			       union "
            + "			     select state_transferred_in.patient_id, art_start_date from "
            + "			       ( "
            + "			           select p.patient_id, obsdata.value_datetime art_start_date from patient p "
            + "			             inner join encounter e on p.patient_id=e.patient_id "
            + "			             inner join obs obstrans on e.encounter_id=obstrans.encounter_id and obstrans.voided=0 and obstrans.concept_id=1369 and obstrans.value_coded=1065 "
            + "			             inner join obs obstarv on e.encounter_id=obstarv.encounter_id and obstarv.voided=0 and obstarv.concept_id=6300 and obstarv.value_coded=6276 "
            + "			             inner join obs obsdata on e.encounter_id=obsdata.encounter_id and obsdata.voided=0 and obsdata.concept_id=23891 "
            + "			             inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			         where p.voided=0 and e.voided=0 and e.encounter_type=53 and obsdata.value_datetime <= curdate() "
            + "			         group by p.patient_id "
            + "			         ) state_transferred_in group by state_transferred_in.patient_id "
            + "			         ) transferred_in on transferred_in.patient_id = patient.patient_id "
            + "			         left join "
            + "			         ( "
            + "				select patient_id, max(encounter_datetime) encounter_datetime from ( "
            + "				Select p.patient_id, max(e.encounter_datetime) encounter_datetime from  patient p "
            + "				inner join encounter e on p.patient_id = e.patient_id "
            + "				inner join location l on l.location_id = e.location_id "
            + "				where  p.voided = 0 and e.voided = 0 and e.encounter_datetime <= curdate() and e.encounter_type = 18 "
            + "				group by p.patient_id "
            + "				union "
            + "				SELECT  p.patient_id, max(o.value_datetime) encounter_datetime FROM  patient p "
            + "				INNER JOIN encounter e on p.patient_id = e.patient_id "
            + "				inner join obs o on e.encounter_id = o.encounter_id "
            + "				inner join location l on l.location_id = e.location_id "
            + "				where  p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 52 "
            + "				AND o.concept_id = 23866 and o.value_datetime is not null and o.value_datetime <= curdate() "
            + "				group by p.patient_id "
            + "				) levantamento group by patient_id "
            + "			         ) levantamento on levantamento.patient_id = patient.patient_id "
            + "			  left join( "
            + "			Select p.patient_id, max(e.encounter_datetime) encounter_datetime from  patient p "
            + "			inner join encounter e on p.patient_id = e.patient_id "
            + "			inner join location l on l.location_id = e.location_id "
            + "			where  p.voided = 0 and e.voided = 0 and e.encounter_datetime <= curdate() and e.encounter_type = 6 "
            + "			group by p.patient_id "
            + "			) fichaClinica  on fichaClinica.patient_id = patient.patient_id "
            + "			left join ( "
            + "			select patient_id,decisao from ( "
            + "			select inicio_real.patient_id,gravida_real.data_gravida, lactante_real.data_parto, "
            + "			if(max(gravida_real.data_gravida) is null and max(lactante_real.data_parto) is null,null, "
            + "			if(max(gravida_real.data_gravida) is null,1, "
            + "			if(max(lactante_real.data_parto) is null,2, "
            + "			if(max(lactante_real.data_parto)=max(gravida_real.data_gravida),2, "
            + "			if(max(lactante_real.data_parto)>max(gravida_real.data_gravida),1,2 "
            + "			))))) decisao from ( "
            + "			select p.patient_id "
            + "			from patient p "
            + "			inner join encounter e on e.patient_id=p.patient_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where e.voided=0 and p.voided=0 and e.encounter_type in (5,7) and e.encounter_datetime "
            + "			between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			select pg.patient_id from patient p "
            + "			inner join patient_program pg on p.patient_id=pg.patient_id "
            + "			inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "			where pg.voided=0 and p.voided=0 and program_id in (1,2) and "
            + "			date_enrolled between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=53 and o.concept_id=23891 "
            + "			and o.value_datetime is not null "
            + "			and o.value_datetime between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() )inicio_real "
            + "			left join ( "
            + "			Select p.patient_id,e.encounter_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1982 "
            + "			and value_coded=1065 and e.encounter_type in (5,6) "
            + "			and e.encounter_datetime  between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id,e.encounter_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1279 "
            + "			and e.encounter_type in (5,6) "
            + "			and e.encounter_datetime between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			Select "
            + "			p.patient_id,e.encounter_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and concept_id=1600 and e.encounter_type in (5,6) "
            + "			and e.encounter_datetime between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id,e.encounter_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and concept_id=6334 and value_coded=6331 and e.encounter_type in (5,6) "
            + "			and e.encounter_datetime  between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			select pp.patient_id,pp.date_enrolled data_gravida from patient_program pp "
            + "			inner join location on (location.location_id = pp.location_id and location.retired =0) "
            + "			where pp.program_id=8 and pp.voided=0 "
            + "			and pp.date_enrolled between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id,obsART.value_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join obs obsART on e.encounter_id=obsART.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and o.concept_id=1982 and o.value_coded=1065 and "
            + "			e.encounter_type=53 "
            + "			and obsART.value_datetime between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			and obsART.concept_id=1190 and obsART.voided=0 "
            + "			union "
            + "			Select p.patient_id,o.value_datetime data_gravida from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and o.concept_id=1465 and e.encounter_type=6 "
            + "			and o.value_datetime between date_sub(curdate(), INTERVAL 9 MONTH) and curdate() "
            + "			) gravida_real on gravida_real.patient_id=inicio_real.patient_id "
            + "			left join ( "
            + "			Select p.patient_id,o.value_datetime data_parto from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=5599 and "
            + "			e.encounter_type in (5,6) "
            + "			and o.value_datetime between date_sub(curdate(), INTERVAL 18 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id, e.encounter_datetime data_parto from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and concept_id=6332 and value_coded=1065 and e.encounter_type=6 "
            + "			and e.encounter_datetime between date_sub(curdate(), INTERVAL 18 MONTH) and curdate() "
            + "			union "
            + "			Select p.patient_id, obsART.value_datetime data_parto from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join obs obsART on e.encounter_id=obsART.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 "
            + "			and o.concept_id=6332 and o.value_coded=1065 and e.encounter_type=53 and "
            + "			obsART.value_datetime between date_sub(curdate(), INTERVAL 18 MONTH) and curdate() "
            + "			and obsART.concept_id=1190 and obsART.voided=0 "
            + "			union "
            + "			Select p.patient_id, e.encounter_datetime data_parto from patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6334 and value_coded=6332 and "
            + "			e.encounter_type in (5,6) "
            + "			and e.encounter_datetime between date_sub(curdate(), INTERVAL 18 MONTH) and curdate() "
            + "			union "
            + "			select pg.patient_id,ps.start_date data_parto from patient p "
            + "			inner join patient_program pg on p.patient_id=pg.patient_id "
            + "			inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "			inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "			where pg.voided=0 and ps.voided=0 and p.voided=0 "
            + "			and pg.program_id=8 and ps.state=27 and ps.end_date is null "
            + "			and ps.start_date between date_sub(curdate(), INTERVAL 18 MONTH) and curdate() "
            + "			) lactante_real on lactante_real.patient_id=inicio_real.patient_id "
            + "			where lactante_real.data_parto is not null or gravida_real.data_gravida is not null "
            + "			group by inicio_real.patient_id "
            + "			) gravidaLactante "
            + "			inner join person pe on pe.person_id=gravidaLactante.patient_id "
            + "			and pe.voided=0 and pe.gender='F' "
            + "			) gravidaLactante on gravidaLactante.patient_id = patient.patient_id "
            + "			inner join "
            + "			( "
            + "			    						select patient_id "
            + "	from "
            + "	(select   	inicio_fila_seg_prox.*, "
            + "			GREATEST(COALESCE(data_fila,data_seguimento,data_recepcao_levantou),COALESCE(data_seguimento,data_fila,data_recepcao_levantou),COALESCE(data_recepcao_levantou,data_seguimento,data_fila))  data_usar_c, "
            + "		    GREATEST(COALESCE(data_proximo_lev,data_proximo_seguimento,data_recepcao_levantou30),COALESCE(data_proximo_seguimento,data_proximo_lev,data_recepcao_levantou30),COALESCE(data_recepcao_levantou30,data_proximo_seguimento,data_proximo_lev)) data_usar "
            + "	from "
            + "		(select 	inicio_fila_seg.*, "
            + "		max(obs_fila.value_datetime) data_proximo_lev, "
            + "		max(obs_seguimento.value_datetime) data_proximo_seguimento, "
            + "		date_add(data_recepcao_levantou, interval 30 day) data_recepcao_levantou30 "
            + "  from "
            + "(select inicio.*, "
            + "		saida.data_estado, "
            + "		max_fila.data_fila, "
            + "		max_consulta.data_seguimento, "
            + "		max_recepcao.data_recepcao_levantou "
            + " from "
            + " (	Select patient_id,min(data_inicio) data_inicio "
            + "		from "
            + "			( "
            + "				Select 	p.patient_id,min(e.encounter_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on o.encounter_id=e.encounter_id "
            + "						inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "				where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "						e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and "
            + "						e.encounter_datetime<=curdate() "
            + "				group by p.patient_id "
            + "				union "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "						inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and "
            + "						o.concept_id=1190 and o.value_datetime is not null and "
            + "						o.value_datetime<=curdate() "
            + "				group by p.patient_id "
            + "				union "
            + "				select 	pg.patient_id,min(date_enrolled) data_inicio "
            + "				from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id "
            + "				inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "				where 	pg.voided=0 and p.voided=0 and program_id=2 "
            + "				and date_enrolled<=curdate() "
            + "				group by pg.patient_id "
            + "				union "
            + "				  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio "
            + "				  FROM 		patient p "
            + "							inner join encounter e on p.patient_id=e.patient_id "
            + "							inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "				  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 "
            + "				  and e.encounter_datetime<=curdate() "
            + "				  GROUP BY 	p.patient_id "
            + "				union "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "						inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "						o.concept_id=23866 and o.value_datetime is not null and "
            + "						o.value_datetime<=curdate() "
            + "				group by p.patient_id "
            + "			) inicio_real "
            + "		group by patient_id "
            + "  )inicio "
            + "  left join "
            + "	( "
            + "	select patient_id,max(data_estado) data_estado "
            + "	from "
            + "		( "
            + "			select distinct max_estado.patient_id, max_estado.data_estado from ( "
            + "				select	pg.patient_id, "
            + "						max(ps.start_date) data_estado "
            + "				from	patient p "
            + "					inner join patient_program pg on p.patient_id = pg.patient_id "
            + "					inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
            + "					inner join location on (location.location_id = pg.location_id and location.retired =0) "
            + "				where pg.voided=0 and ps.voided=0 and p.voided=0 and pg.program_id = 2 "
            + "					and ps.start_date<= curdate() "
            + "					group by pg.patient_id "
            + "			) max_estado "
            + "				inner join patient_program pp on pp.patient_id = max_estado.patient_id "
            + "				inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
            + "				inner join location on (location.location_id = pp.location_id and location.retired =0) "
            + "			where pp.program_id = 2 and ps.state in (7,8,10) and pp.voided = 0 and ps.voided = 0 "
            + "			union "
            + "			select 	p.patient_id, "
            + "					max(o.obs_datetime) data_estado "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs  o on e.encounter_id=o.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "					e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and "
            + "					o.obs_datetime<=curdate() "
            + "			group by p.patient_id "
            + "			union "
            + "			select person_id as patient_id,death_date as data_estado "
            + "			from person "
            + "			where dead=1 and death_date is not null and death_date<=curdate() "
            + "			union "
            + "			select 	p.patient_id, "
            + "					max(obsObito.obs_datetime) data_estado "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs obsObito on e.encounter_id=obsObito.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and "
            + "					e.encounter_type in (21,36,37) and  e.encounter_datetime<=curdate() and "
            + "					obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366 "
            + "			group by p.patient_id "
            + "			union "
            + "			select 	p.patient_id,max(e.encounter_datetime) data_estado "
            + "			from	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on o.encounter_id=e.encounter_id "
            + "					inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "			where 	e.voided=0 and p.voided=0 and e.encounter_datetime<=curdate() and "
            + "					o.voided=0 and o.concept_id=2016 and o.value_coded in (1706,23863) and e.encounter_type in (21,36,37) "
            + "			group by p.patient_id "
            + "		) allSaida "
            + "	group by patient_id "
            + "  ) saida on inicio.patient_id=saida.patient_id "
            + " left join "
            + "  ( Select p.patient_id,max(encounter_datetime) data_fila "
            + "	from 	patient p "
            + "			inner join encounter e on e.patient_id=p.patient_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "	where 	p.voided=0 and e.voided=0 and e.encounter_type=18 and "
            + "			e.encounter_datetime<=curdate() "
            + "	group by p.patient_id "
            + " ) max_fila on inicio.patient_id=max_fila.patient_id "
            + "  left join "
            + "  (	Select 	p.patient_id,max(encounter_datetime) data_seguimento "
            + "	from 	patient p "
            + "			inner join encounter e on e.patient_id=p.patient_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "	where 	p.voided=0 and e.voided=0 and e.encounter_type in (6,9) and "
            + "			e.encounter_datetime<=curdate() "
            + "	group by p.patient_id "
            + " ) max_consulta on inicio.patient_id=max_consulta.patient_id "
            + "  left join "
            + "  ( "
            + "	Select 	p.patient_id,max(value_datetime) data_recepcao_levantou "
            + "	from 	patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "			inner join location on (location.location_id = e.location_id and location.retired =0) "
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "			o.concept_id=23866 and o.value_datetime is not null and "
            + "			o.value_datetime<=curdate() "
            + "	group by p.patient_id "
            + "  ) max_recepcao on inicio.patient_id=max_recepcao.patient_id "
            + "  group by inicio.patient_id "
            + " ) inicio_fila_seg "
            + "  left join "
            + "	 obs obs_fila on obs_fila.person_id=inicio_fila_seg.patient_id "
            + "	 inner join location lo on (lo.location_id = obs_fila.location_id and lo.retired =0) "
            + "   and obs_fila.voided=0 "
            + "	 and obs_fila.obs_datetime=inicio_fila_seg.data_fila "
            + "	 and obs_fila.concept_id=5096 "
            + "  left join "
            + "	obs obs_seguimento on obs_seguimento.person_id=inicio_fila_seg.patient_id "
            + "	and obs_seguimento.location_id = lo.location_id "
            + "	and obs_seguimento.voided=0 "
            + "	and obs_seguimento.obs_datetime=inicio_fila_seg.data_seguimento "
            + "	and obs_seguimento.concept_id=1410 "
            + " group by inicio_fila_seg.patient_id "
            + " ) inicio_fila_seg_prox "
            + " group by patient_id "
            + " ) coorte12meses_final "
            + " where (data_estado is null or (data_estado is not null and  data_usar_c>data_estado)) and date_add(data_usar, interval 28 day) >=curdate() "
            + "			) tx_curr on tx_curr.patient_id = patient.patient_id "
            + "                            where patient_identifier.voided = 0 "
            + "                            and patient.voided =0 "
            + "                            and person.voided = 0 "
            + "                           group by patient_identifier.patient_identifier_id order by patient_identifier.identifier, patient_identifier.date_created desc ";
  }
}
